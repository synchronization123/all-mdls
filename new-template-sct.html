<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MCR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- Select2 for searchable dropdowns -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-5-theme/1.3.0/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f9;
      margin: 0;
    }

    .sidebar {
      width: 240px;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      background-color: #343a40;
      padding: 20px 15px;
      color: white;
      z-index: 1030;
    }

    .sidebar h4 {
      color: #fff;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .sidebar .nav-link {
      color: #adb5bd;
      padding: 10px 15px;
      margin-bottom: 5px;
      border-radius: 4px;
    }

    .sidebar .nav-link:hover, .sidebar .nav-link.active {
      background-color: #495057;
      color: #fff;
    }

    .main-content {
      margin-left: 240px;
      padding: 2rem 2rem;
    }

    .card {
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .table thead {
      background-color: #343a40;
      color: #fff;
    }

    .table-hover tbody tr:hover {
      background-color: #f1f1f1;
    }

    .pagination-controls .btn {
      margin-right: 6px;
    }

    .spinner-border {
      width: 3rem;
      height: 3rem;
    }

    #loadingModal .modal-dialog {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    .filters-section {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .filter-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-end;
    }
    
    .filter-item {
      flex: 1 1 12%;
      min-width: 110px;
      margin-right: 5px;
    }
    
    .filter-label {
      font-size: 0.8rem;
      margin-bottom: 2px;
      font-weight: 500;
    }
    
    .filter-input {
      height: 36px;
      font-size: 0.9rem;
    }
    
    .filter-buttons {
      display: flex;
      gap: 8px;
      align-self: flex-end;
    }

    .select2-container--bootstrap-5 .select2-selection {
      height: 36px;
      font-size: 0.9rem;
    }
    
.table-container {
  max-height: 70vh; /* Already present, ensures scrollable area */
  overflow-y: auto;
  margin-bottom: 1rem;
  position: relative; /* Ensure positioning context for sticky headers */
}
    
    .table-container thead th {
      position: sticky;
      top: 0;
      background-color: #343a40;
      color: #fff;
      z-index: 1;
    }

/* Style for the first row of headers */
.table-container thead tr:first-child th {
  position: sticky;
  top: 0;
  background-color: #343a40; /* Matches existing background */
  color: #fff;
  z-index: 2; /* Higher than content but lower than filters */
}


/* Ensure table body rows don't overlap headers */
.table-container tbody tr {
  position: relative;
  z-index: 1; /* Lower than headers */
}

/* Style for the second row of headers (Jira sub-headers) */
.table-container thead tr:nth-child(2) th {
  position: sticky;
  top: 38px; /* Adjust this value based on the height of the first row */
  background-color: #343a40; /* Matches existing background */
  color: #fff;
  z-index: 2;
}







    .status-counts {
      text-align: center;
      margin-bottom: 20px;
    }

    .status-counts h3 {
      display: inline-block;
      margin: 0 20px;
    }

    .highlight-today {
      background-color: #780E12;
      color: #fff;
    }

    .highlight-upcoming {
      background-color: #D9AB0C;
      color: #000;
    }

    .total-row {
      font-weight: bold;
      background-color: #e9ecef;
    }

    .total-column {
      font-weight: bold;
    }

    @media (max-width: 1199px) {
      .filter-item {
        flex: 1 1 20%;
        min-width: 140px;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        position: relative;
        width: 100%;
        height: auto;
      }

      .main-content {
        margin-left: 0;
      }
      
      .filter-item {
        flex: 1 1 30%;
        min-width: 180px;
      }
    }
	
	
	/* Add this to your existing CSS */
.filters-section {
  width: 100%;
}

.filter-buttons-left, .filter-buttons-right {
  display: flex;
  gap: 10px; /* Adjust spacing between buttons as needed */
}

.filter-buttons-left {
  flex-grow: 1; /* Allows left buttons to take available space */
}

.filter-buttons-right {
  flex-shrink: 0; /* Prevents right buttons from shrinking */
}


  </style>
  
  
  
  
  
 <style>
  .select2-dropdown-wide {
    min-width: 300px !important;
  }
  .select2-container .select2-selection--single,
  .select2-container .select2-selection--multiple {
    height: 38px;
  }
  .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__rendered {
    max-height: 100px;
    overflow-y: auto;
  }
</style> 
  
<style>
  .btn-round {
    border-radius: 50px !important;
    padding-left: 1rem;
    padding-right: 1rem;
    font-weight: 500;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  }

  .btn-lg-round {
    border-radius: 50px !important;
    padding: 0.375rem 1.5rem;
    font-weight: 600;
    font-size: 1rem;
  }

  .filter-button-table {
    width: 100%;
    margin-bottom: 1rem;
  }

  .filter-button-table td {
    vertical-align: middle;
    text-align: center;
  }

  .filter-button-table td.left,
  .filter-button-table td.right {
    width: 25%;
  }

  .filter-button-table td.center {
    width: 50%;
  }

  .filter-button-table td.left {
    text-align: left;
  }

  .filter-button-table td.right {
    text-align: right;
  }

  .filter-button-table .btn {
    margin: 0.25rem;
  }
</style>
  
  
  
  
  
  
  
</head>
<body>

  <!-- Sidebar Menu -->
  <div class="sidebar">
    <h4><i class="bi bi-shield-lock"></i> Team AppSec</h4>
    <nav class="nav flex-column">
      <a href="https://demo.defectdojo.org/access_file/4385/63476/Engagement" class="nav-link active"><i class="bi bi-table"></i> Patch</a>
      <a href="https://demo.defectdojo.org/access_file/4432/63476/Engagement" class="nav-link"><i class="bi bi-table"></i> MCR</a>
      <a href="https://demo.defectdojo.org/access_file/4550/63476/Engagement" class="nav-link"><i class="bi bi-table"></i> SCA</a>
      <a href="https://demo.defectdojo.org/access_file/4551/63476/Engagement" class="nav-link"><i class="bi bi-table"></i> Contrast</a>
	  <a href="https://demo.defectdojo.org/access_file/4552/63476/Engagement" class="nav-link"><i class="bi bi-table"></i> Sonar</a>
	  <a href="https://demo.defectdojo.org/access_file/4553/63476/Engagement" class="nav-link"><i class="bi bi-table"></i> Cases</a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="card p-4">
      <h3 class="mb-4 text-primary fw-bold">MCR</h3>

      <!-- Status Counts -->
      <div class="status-counts">
        <h3>Not Started: <span id="notStartedCount">0</span></h3>
        <h3>In Progress: <span id="inProgressCount">0</span></h3>
        <h3>On Hold: <span id="onHoldCount">0</span></h3>
      </div>

      <!-- Filters Section - Two Rows -->
      <div class="filters-section">
        <!-- First Row -->
        <div class="filter-container mb-3">
          <div class="filter-item">
            <label class="filter-label" for="idFilter">ID</label>
            <input type="number" class="form-control form-control-sm filter-input" id="idFilter" placeholder="ID">
          </div>
          <div class="filter-item">
            <label class="filter-label" for="createdFilter">Created On</label>
            <input type="date" class="form-control form-control-sm filter-input" id="createdFilter">
          </div>
          <div class="filter-item">
            <label class="filter-label" for="agingFilter">Aging</label>
            <div class="input-group input-group-sm">
              <select class="form-select filter-input" id="agingCondition">
                <option value="lt"><</option>
                <option value="gt">></option>
                <option value="eq">=</option>
              </select>
              <input type="number" class="form-control filter-input" id="agingFilter" placeholder="Days">
            </div>
          </div>
          <div class="filter-item">
            <label class="filter-label" for="createdByFilter">Created By</label>
            <select class="form-select form-select-sm filter-input searchable-select" id="createdByFilter">
              <option value="">All</option>
            </select>
          </div>
          <div class="filter-item">
            <label class="filter-label" for="statusAnalystFilter">Status (Analyst)</label>
            <select class="form-select form-select-sm filter-input" id="statusAnalystFilter">
              <option value="">All</option>
            </select>
          </div>
          <div class="filter-item">
            <label class="filter-label" for="statusMentorFilter">Status (Mentor)</label>
            <select class="form-select form-select-sm filter-input" id="statusMentorFilter">
              <option value="">All</option>
            </select>
          </div>
          <div class="filter-item">
            <label class="filter-label" for="statusLeadFilter">Status (Lead)</label>
            <select class="form-select form-select-sm filter-input" id="statusLeadFilter">
              <option value="">All</option>
            </select>
          </div>
        </div>

        <!-- Second Row -->
        <div class="filter-container">
          <div class="filter-item">
            <label class="filter-label" for="nameFilter">Name</label>
            <input type="text" class="form-control form-control-sm filter-input" id="nameFilter" placeholder="Name">
          </div>
          <div class="filter-item">
            <label class="filter-label" for="assignedToFilter">Assigned To</label>
            <select class="form-select form-select-sm filter-input searchable-select" id="assignedToFilter">
              <option value="">All</option>
            </select>
          </div>
          <div class="filter-item">
            <label class="filter-label" for="appSecETAFilter">AppSec ETA</label>
            <input type="date" class="form-control form-control-sm filter-input" id="appSecETAFilter">
          </div>
          <div class="filter-item">
            <label class="filter-label" for="rmETAFilter">RM ETA</label>
            <input type="date" class="form-control form-control-sm filter-input" id="rmETAFilter">
          </div>
          <div class="filter-item">
            <label class="filter-label" for="irFilter">IR</label>
            <input type="text" class="form-control form-control-sm filter-input" id="irFilter" placeholder="IR">
          </div>
          
		  
		  
		  <table class="filter-button-table">
  <tr>
    <!-- Left Buttons -->
    <td class="left">
      <button id="newEngagement" class="btn btn-success btn-sm btn-round">
            <i class="bi bi-plus-circle"></i> New
          </button>
          <button id="reassignEngagements" class="btn btn-info btn-sm btn-round">
            <i class="bi bi-person-plus"></i> Reassignment
          </button>
          <button id="bulkCloseEngagements" class="btn btn-danger btn-sm btn-round">
            <i class="bi bi-x-circle"></i> Bulk Close

          <button id="viewMCR" class="btn btn-danger btn-sm btn-round">
            <i class="bi bi-x-circle"></i> View MCR
          </button>
        </td>	  
    </td>

    <td class="center">
  <button id="viewSummary" class="btn btn-info btn-sm btn-round">
    <i class="bi bi-eye"></i> Open
  </button>
  <button id="completedSummary" class="btn btn-primary btn-sm btn-round">
    <i class="bi bi-check-circle"></i> Completed
  </button>
  <button id="viewClosed" class="btn btn-warning btn-sm btn-round">
    <i class="bi bi-archive"></i> Closed
  </button>
  <button id="viewJiras" class="btn btn-info btn-sm btn-round">
    <i class="bi bi-ticket-detailed"></i> Patch Jira
  </button>
  <button id="testsSummary" class="btn btn-success btn-sm btn-round">
    <i class="bi bi-list-check"></i> Tests Summary
  </button>
  <button id="reportEngagements" class="btn btn-primary btn-sm btn-round">
    <i class="bi bi-file-earmark-text"></i> Report
  </button>
  <button id="searchJira" class="btn btn-info btn-sm btn-round">
    <i class="bi bi-search"></i> Search Jira
  </button>
</td>

    <!-- Right Buttons -->
    <td class="right">
      <button id="applyFilters" class="btn btn-primary btn-sm btn-lg-round">
        <i class="bi bi-search"></i> Go
      </button>
      <button id="resetFilters" class="btn btn-outline-secondary btn-sm btn-round">
        <i class="bi bi-x-circle"></i> Reset
      </button>
      <button id="refreshTable" class="btn btn-primary btn-sm btn-round">
        <i class="bi bi-arrow-repeat"></i> Refresh
      </button>
    </td>
  </tr>
</table>
		  
		  
		  
		  
		  
		  
		  
		  
		  
		  
		  
        </div>
      </div>

      <!-- Pagination Controls -->
      <div class="d-flex justify-content-between align-items-center mb-3 pagination-controls">
        <div>
          <button class="btn btn-sm btn-outline-primary" id="firstPage"><i class="bi bi-skip-start-fill"></i> First</button>
          <button class="btn btn-sm btn-outline-secondary" id="prevPage"><i class="bi bi-caret-left-fill"></i> Prev</button>
          <button class="btn btn-sm btn-outline-secondary" id="nextPage">Next <i class="bi bi-caret-right-fill"></i></button>
          <button class="btn btn-sm btn-outline-primary" id="lastPage">Last <i class="bi bi-skip-end-fill"></i></button>
        </div>
        <div id="paginationStatus" class="text-muted small"></div>
      </div>

      <!-- Main Table -->
      <div class="table-container">
  <table class="table table-hover table-bordered align-middle">
    <thead>
      <tr>
        <th>ID</th>
        <th>Created</th>
        <th>Aging</th>
        <th>Name</th>
        <th colspan="5">Jira</th>
        <th>Assigned To</th>
        <th>AppSec ETA</th>
        <th>Status (Analyst)</th>
        <th>Status (Mentor)</th>
        <th>Status (Lead)</th>
        <th>IR</th>
        <th>Description</th>
        <th>Action</th>
      </tr>
      <tr>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th>Total</th>
        <th>Security</th>
        <th>Functional</th>
        <th>Doable</th>
        <th>Non Doable</th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody id="engagementTableBody"></tbody>
  </table>
</div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div class="modal show" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <h5 class="modal-title fw-semibold">Loading Patches data, please wait...</h5>
      </div>
    </div>
  </div>

  <!-- Edit Engagement Modal -->
  <div class="modal fade" id="editEngagementModal" tabindex="-1" aria-labelledby="editEngagementModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="editEngagementModalLabel">Edit Patch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="modalCloseX"></button>
        </div>
        <div class="modal-body">
          <form id="editEngagementForm">
            <input type="hidden" name="csrfmiddlewaretoken" id="csrfToken" value="">
            
            <!-- Row 1: ID, Created, Created By -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">ID</label>
                <input type="text" class="form-control" id="editId" readonly>
              </div>
              <div class="col-md-4">
                <label class="form-label">Created</label>
                <input type="text" class="form-control" id="editCreated" readonly>
              </div>
              <div class="col-md-4">
                <label class="form-label">Created By</label>
                <input type="text" class="form-control" id="editCreatedBy" readonly>
              </div>
            </div>
            
            <!-- Row 2: Name, Assigned To, Product -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">Name</label>
                <input type="text" class="form-control fw-bold" id="editName" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Assigned To</label>
                <select class="form-select searchable-select" id="editAssignedTo">
                  <option value="">Unassigned</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Product</label>
                <select class="form-select searchable-select" id="editProduct" required>
                  <option value="">Select Product</option>
                </select>
              </div>
            </div>
            
            <!-- Row 3: AppSec ETA, RM ETA, IR -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">AppSec ETA</label>
                <input type="date" class="form-control" id="editAppSecETA" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">RM ETA</label>
                <input type="date" class="form-control" id="editRmETA" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">IR</label>
                <input type="text" class="form-control" id="editIR" pattern="[0-9]*" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
              </div>
            </div>
            
            <!-- Row 4: Status fields -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">Status (Analyst)</label>
                <select class="form-select" id="editStatusAnalyst">
                  <option value="Not Started">Not Started</option>
                  <option value="In Progress">In Progress</option>
                  <option value="On Hold">On Hold</option>
                  <option value="Completed">Completed</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Status (Mentor)</label>
                <select class="form-select" id="editStatusMentor">
                  <option value="Not Started">Not Started</option>
                  <option value="In Progress">In Progress</option>
                  <option value="On Hold">On Hold</option>
                  <option value="Completed">Completed</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Status (Lead)</label>
                <select class="form-select" id="editStatusLead">
                  <option value="Not Started">Not Started</option>
                  <option value="Approved">Approved</option>
                  <option value="Approved with Exception">Approved with Exception</option>
                  <option value="Rejected">Rejected</option>
                </select>
              </div>
            </div>
            
            <!-- Row 5: Comment -->
            <div class="row mb-3">
              <div class="col-12">
                <label class="form-label">Comment</label>
                <textarea class="form-control" id="editComment" rows="5" style="height: 10cm; width: 100%;"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="closeEditModal">Close</button>
          <button type="button" class="btn btn-primary" id="saveEngagement">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal for Edit -->
  <div class="modal fade" id="confirmCloseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Unsaved Changes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you don't want to save data?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="confirmNoBtn" data-bs-dismiss="modal">No</button>
          <button type="button" class="btn btn-primary" id="confirmCloseBtn">Yes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- View Summary Modal -->
  <div class="modal fade" id="summaryModal" tabindex="-1" aria-labelledby="summaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background-color: #343a40; color: #fff;">
          <h5 class="modal-title" id="summaryModalLabel">Patches Summary</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Assigned To</th>
                <th>Not Started</th>
                <th>In Progress</th>
                <th>On Hold</th>
                <th>Completed</th>
                <th class="total-column">Total</th>
              </tr>
            </thead>
            <tbody id="summaryTableBody"></tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- New Engagement Modal -->
  <div class="modal fade" id="newEngagementModal" tabindex="-1" aria-labelledby="newEngagementModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="newEngagementModalLabel">New Patch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="newModalCloseX"></button>
        </div>
        <div class="modal-body">
          <form id="newEngagementForm">
            <input type="hidden" name="csrfmiddlewaretoken" id="newCsrfToken" value="">
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" id="newName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">AppSec ETA</label>
              <input type="date" class="form-control" id="newTargetStart" required>
            </div>
            <div class="mb-3">
              <label class="form-label">RM ETA</label>
              <input type="date" class="form-control" id="newTargetEnd" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Status</label>
              <input type="text" class="form-control" id="newStatus" value="Not Started" readonly>
            </div>
            <div class="mb-3">
              <label class="form-label">Assigned To</label>
              <select class="form-select searchable-select" id="newLead">
                <option value="">Unassigned</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Product</label>
              <select class="form-select searchable-select" id="newProduct" required>
                <option value="">Select Product</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Created By</label>
              <input type="text" class="form-control" id="newCreatedBy" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="closeNewModal">Close</button>
          <button type="button" class="btn btn-primary" id="saveNewEngagement">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal for Close -->
  <div class="modal fade" id="confirmCloseEngagementModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Close</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to close this Patch?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
          <button type="button" class="btn btn-danger" id="confirmCloseEngagementBtn">Yes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- View Closed Engagements Modal -->
  <div class="modal fade" id="viewClosedModal" tabindex="-1" aria-labelledby="viewClosedModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background-color: #343a40; color: #fff;">
          <h5 class="modal-title" id="viewClosedModalLabel">Closed Patches</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <h6>Total Closed Patches: <span id="totalClosedCount">0</span></h6>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <button class="btn btn-sm btn-outline-primary" id="closedFirstPage"><i class="bi bi-skip-start-fill"></i> First</button>
              <button class="btn btn-sm btn-outline-secondary" id="closedPrevPage"><i class="bi bi-caret-left-fill"></i> Prev</button>
              <button class="btn btn-sm btn-outline-secondary" id="closedNextPage">Next <i class="bi bi-caret-right-fill"></i></button>
              <button class="btn btn-sm btn-outline-primary" id="closedLastPage">Last <i class="bi bi-skip-end-fill"></i></button>
            </div>
            <div id="closedPaginationStatus" class="text-muted small"></div>
          </div>
          <div class="table-container">
            <table class="table table-hover table-bordered align-middle">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Assigned To</th>
                  <th>Created by</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="closedEngagementTableBody"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Completed Summary Modal -->
  <div class="modal fade" id="completedSummaryModal" tabindex="-1" aria-labelledby="completedSummaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background-color: #343a40; color: #fff;">
          <h5 class="modal-title" id="completedSummaryModalLabel">Completed Summary</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Start Date (Updated)</label>
              <input type="date" class="form-control" id="completedStartDate">
            </div>
            <div class="col-md-6">
              <label class="form-label">End Date (Updated)</label>
              <input type="date" class="form-control" id="completedEndDate">
            </div>
          </div>
          <button id="fetchCompletedSummary" class="btn btn-primary mb-3">Fetch Summary</button>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Total Completed</th>
                <th>Approved</th>
                <th>Approved with Exception</th>
                <th>Rejected</th>
              </tr>
            </thead>
            <tbody id="completedSummaryTableBody">
              <tr>
                <td id="totalCompleted">0</td>
                <td id="approvedCount">0</td>
                <td id="approvedWithExceptionCount">0</td>
                <td id="rejectedCount">0</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Jiras Modal -->
<div class="modal fade" id="addJirasModal" tabindex="-1" aria-labelledby="addJirasModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="addJirasModalLabel">Add Jiras</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="jirasModalCloseX"></button>
      </div>
      <div class="modal-body">
        <form id="addJirasForm">
          <input type="hidden" id="jiraEngagementId">
          <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" class="form-control" id="jiraTitle">
          </div>
          <div class="mb-3">
            <label class="form-label">Drag and Drop Files (txt, csv, xlsx, xls)</label>
            <div id="dropZone" class="border p-3 text-center" style="background-color: #f8f9fa; cursor: pointer;">
              Drop files here or click to upload
              <input type="file" id="jiraFileInput" accept=".txt,.csv,.xlsx,.xls" multiple hidden>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Comma-Separated Jira Keys</label>
            <textarea class="form-control" id="jiraKeysTextarea" rows="3" placeholder="e.g., JIRA-123, JIRA-456"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="closeJirasModal">Close</button>
        <button type="button" class="btn btn-primary" id="saveJiras">Save</button>
      </div>
    </div>
  </div>
</div>
  
  
 

<div class="modal fade" id="viewJirasModal" tabindex="-1" aria-labelledby="viewJirasModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #343a40; color: #fff;">
        <h5 class="modal-title" id="viewJirasModalLabel">View Jiras</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-4">
            <select class="form-select searchable-select" id="engagementSelect">
              <option value="">Select a Patch</option>
            </select>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-3">
            <input type="text" class="form-control" id="jiraTitleSearch" placeholder="Search Jira...">
          </div>
          <div class="col-md-2">
            <select class="form-select" id="jiraTypeFilter">
              <option value="">All Jira Types</option>
              <option value="Security">Security</option>
              <option value="Functional">Functional</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" id="analysisStatusFilter">
              <option value="">All Analysis Status</option>
              <option value="Not Started">Not Started</option>
              <option value="In Progress">In Progress</option>
              <option value="On Hold">On Hold</option>
              <option value="Completed">Completed</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" id="jiraStatusFilter">
              <option value="">All Jira Status</option>
              <option value="To Do">To Do</option>
              <option value="In Progress">In Progress</option>
              <option value="Ready for Testing">Ready for Testing</option>
              <option value="Done">Done</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select searchable-select" id="assignedToFilterJira">
              <option value="">All Assigned To</option>
            </select>
          </div>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <button class="btn btn-sm btn-outline-primary" id="jiraFirstPage"><i class="bi bi-skip-start-fill"></i> First</button>
            <button class="btn btn-sm btn-outline-secondary" id="jiraPrevPage"><i class="bi bi-caret-left-fill"></i> Prev</button>
            <button class="btn btn-sm btn-outline-secondary" id="jiraNextPage">Next <i class="bi bi-caret-right-fill"></i></button>
            <button class="btn btn-sm btn-outline-primary" id="jiraLastPage">Last <i class="bi bi-skip-end-fill"></i></button>
          </div>
          <div id="jiraPaginationStatus" class="text-muted small"></div>
        </div>
        <div class="table-container">
          <table class="table table-hover table-bordered align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Description</th>
                <th>Jira Type</th>
                <th>Analysis Status</th>
                <th>Jira Status</th>
                <th>Assigned To</th>
                <th>Action</th> <!-- New column for Save button -->
              </tr>
            </thead>
            <tbody id="jiraTableBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>




<!-- Add Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #343a40; color: #fff;">
        <h5 class="modal-title" id="reportModalLabel">Patch Report</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <button id="riskRegister" class="btn btn-primary btn-sm mb-2">
            <i class="bi bi-shield-exclamation"></i> Risk Register
          </button>
        </div>
        <div class="mb-3">
          <label class="form-label">Select Patch</label>
          <select class="form-select searchable-select" id="reportEngagementSelect">
            <option value="">Select a Patch</option>
          </select>
        </div>
        <!-- Summary Table -->
        <h6>Summary</h6>
        <div class="table-container mb-4">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Name</th>
                <th>Prepared By</th>
                <th>Total Changelogs</th>
              </tr>
            </thead>
            <tbody id="summaryReportBody"></tbody>
          </table>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Contrast Verification</th>
                <th>Conclusion</th>
              </tr>
            </thead>
            <tbody id="contrastReportBody"></tbody>
          </table>
        </div>
        <!-- Build Analysis Table -->
        <h6>Build Analysis</h6>
        <div class="table-container mb-4">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Build</th>
                <th>Date</th>
                <th>Total Number of Jiras</th>
              </tr>
            </thead>
            <tbody id="buildHeaderReportBody"></tbody>
          </table>
          <hr>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Sr. No.</th>
                <th>Changelog Reviewer</th>
                <th>Issue Key</th>
                <th>Jira Type</th>
                <th>Manual Secure Code Review</th>
                <th>Manual Security Testing</th>
                <th>Remark</th>
                <th>Jira Status</th>
              </tr>
            </thead>
            <tbody id="buildAnalysisReportBody"></tbody>
          </table>
        </div>
        <!-- Risk Register Table -->
        <h6>Risk Register</h6>
        <div class="table-container">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Sr. No.</th>
                <th>Category</th>
                <th>Status</th>
                <th>Comment</th>
              </tr>
            </thead>
            <tbody id="riskRegisterReportBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="viewReport">View</button>
      </div>
    </div>
  </div>
</div>

<!-- Risk Register Modal -->
<div class="modal fade" id="riskRegisterModal" tabindex="-1" aria-labelledby="riskRegisterModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="riskRegisterModalLabel">Risk Register for <span id="riskEngagementName"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="riskModalCloseX"></button>
      </div>
      <div class="modal-body">
        <div id="riskTestsContainer">
          <h6>Tests to Create</h6>
          <ul class="list-group">
            <li class="list-group-item">reporting_patches (Acunetix Scan)</li>
            <li class="list-group-item">SQL Injection (Azure Security Center)</li>
            <li class="list-group-item">XSS (Azure Security Center)</li>
            <li class="list-group-item">XXE (Azure Security Center)</li>
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="closeRiskModal">Close</button>
        <button type="button" class="btn btn-primary" id="createAllRiskTests">Create All</button>
      </div>
    </div>
  </div>
</div>
 


<div class="modal fade" id="searchJiraModal" tabindex="-1" aria-labelledby="searchJiraModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #343a40; color: #fff;">
        <h5 class="modal-title" id="searchJiraModalLabel">Search Jira</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div class="input-group">
            <input type="text" class="form-control" id="jiraSearchInput" placeholder="Search Jira by title...">
            <button class="btn btn-primary" id="searchJiraGo">Go</button>
          </div>
        </div>
        <div class="table-container" style="max-height: 60vh; overflow-y: auto;">
          <table class="table table-hover table-bordered align-middle">
            <thead>
              <tr>
                <th>Id</th>
                <th>Title</th>
                <th>Description</th>
                <th>Engagement</th>
                <th>Lead</th>
              </tr>
            </thead>
            <tbody id="searchJiraTableBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="reassignmentModal" tabindex="-1" aria-labelledby="reassignmentModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #343a40; color: #fff;">
        <h5 class="modal-title" id="reassignmentModalLabel">Engagement Reassignment</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-2">
            <input type="text" class="form-control" id="reassignIdFilter" placeholder="Search ID...">
          </div>
          <div class="col-md-3">
            <select class="form-select searchable-select" id="reassignNameFilter">
              <option value="">All Patch Names</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" id="reassignStatusFilter">
              <option value="">All Status</option>
              <option value="Not Started">Not Started</option>
              <option value="In Progress">In Progress</option>
              <option value="On Hold">On Hold</option>
              <option value="Completed">Completed</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select searchable-select" id="reassignProductFilter" multiple>
              <option value="">All Products</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select searchable-select" id="reassignLeadFilter" multiple>
              <option value="">All Leads</option>
            </select>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-12">
            <button class="btn btn-outline-primary btn-sm me-2" id="applyReassignFilters">Apply Filters</button>
            <button class="btn btn-outline-secondary btn-sm" id="clearReassignFilters">Clear Filters</button>
          </div>
        </div>
        <div class="table-container">
          <table class="table table-hover table-bordered align-middle">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllReassign"></th>
                <th>ID</th>
                <th>Jira ID</th>
                <th>Environment</th>
                <th>Version</th>
                <th>Issue Type</th>
                <th>Jira Status</th>				
				<th>Analysis Status</th>
                <th>Assigned To</th>
              </tr>
            </thead>
            <tbody id="reassignmentTableBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="reassignLeads">Reassign</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<div class="modal fade" id="bulkCloseModal" tabindex="-1" aria-labelledby="bulkCloseModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header" style="background-color: #343a40; color: #fff;">
          <h5 class="modal-title" id="bulkCloseModalLabel">Bulk Close Engagements</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-2">
              <input type="text" class="form-control" id="bulkCloseIdFilter" placeholder="Search ID...">
            </div>
            <div class="col-md-3">
              <select class="form-select searchable-select" id="bulkCloseNameFilter">
                <option value="">All Patch Names</option>
              </select>
            </div>
            <div class="col-md-2">
              <select class="form-select" id="bulkCloseStatusFilter">
                <option value="">All Status</option>
                <option value="Not Started">Not Started</option>
                <option value="In Progress">In Progress</option>
                <option value="On Hold">On Hold</option>
                <option value="Completed">Completed</option>
              </select>
            </div>
            <div class="col-md-3">
              <select class="form-select searchable-select" id="bulkCloseProductFilter" multiple>
                <option value="">All Products</option>
              </select>
            </div>
            <div class="col-md-2">
              <select class="form-select searchable-select" id="bulkCloseLeadFilter" multiple>
                <option value="">All Leads</option>
              </select>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-12">
              <button class="btn btn-outline-primary btn-sm me-2" id="applyBulkCloseFilters">Apply Filters</button>
              <button class="btn btn-outline-secondary btn-sm" id="clearBulkCloseFilters">Clear Filters</button>
            </div>
          </div>
          <div class="table-container">
            <table class="table table-hover table-bordered align-middle">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllBulkClose"></th>
                  <th>ID</th>
                  <th>Patch Name</th>
                  <th>Status (Analyst)</th>
                  <th>Product</th>
                  <th>Lead</th>
                </tr>
              </thead>
              <tbody id="bulkCloseTableBody"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="bulkCloseAction">Close Selected</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
 <div class="modal fade" id="viewMCRModal" tabindex="-1" aria-labelledby="viewMCRModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #343a40; color: #fff;">
        <h5 class="modal-title" id="viewMCRModalLabel">View MCR</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
		
	
      </div>
      <div class="modal-body">
  <div class="row mb-3">
    <div class="col-md-3">
      <input type="text" class="form-control" id="mcrTitleSearch" placeholder="Search Title...">
    </div>
    <div class="col-md-3">
      <select class="form-select searchable-select" id="mcrVersionFilter">
        <option value="">All Versions</option>
      </select>
    </div>
  </div>
  <div class="row mb-3">
    <div class="col-md-2">
      <select class="form-select" id="mcrStatusFilter">
        <option value="">All Status</option>
      </select>
    </div>
    <div class="col-md-3">
      <select class="form-select searchable-select" id="mcrAssignedToFilter">
        <option value="">All Assigned To</option>
      </select>
    </div>
    <div class="col-md-2">
      <select class="form-select" id="mcrTypeFilter">
        <option value="">All Types</option>
      </select>
    </div>
    <div class="col-md-2">
      <select class="form-select" id="mcrIssueTypeFilter">
        <option value="">All Issue Types</option>
      </select>
    </div>
    <div class="col-md-2">
      <select class="form-select" id="mcrJiraStatusFilter">
        <option value="">All Jira Status</option>
      </select>
    </div>
  </div>
  <div class="row mb-3">
    <div class="col-md-12">
      <button class="btn btn-sm btn-primary" id="applyMCRFilters">Apply Filters</button>
      <button class="btn btn-sm btn-secondary" id="clearMCRFilters">Clear Filters</button>
	  
	<button class="btn btn-sm btn-secondary" id="refreshMCRData">Refresh</button>
	  
	  
    </div>
	
	
	
	
	
	
	
	
  </div>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <button class="btn btn-sm btn-outline-primary" id="mcrFirstPage"><i class="bi bi-skip-start-fill"></i> First</button>
      <button class="btn btn-sm btn-outline-secondary" id="mcrPrevPage"><i class="bi bi-caret-left-fill"></i> Prev</button>
      <button class="btn btn-sm btn-outline-secondary" id="mcrNextPage">Next <i class="bi bi-caret-right-fill"></i></button>
      <button class="btn btn-sm btn-outline-primary" id="mcrLastPage">Last <i class="bi bi-skip-end-fill"></i></button>
    </div>
    <div class="d-flex align-items-center">
      <span id="mcrPaginationStatus" class="text-muted small me-3"></span>
      <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
    </div>
  </div>
  <div class="table-container">
    <table class="table table-hover table-bordered align-middle">
      <thead>
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Description</th>
          <th>Version</th>
          <th>Status</th>
          <th>Assigned To</th>
          <th>Type</th>
          <th>Issue Type</th>
          <th>Jira Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="mcrTableBody"></tbody>
    </table>
  </div>
</div>

  
  
  
  
<div class="modal fade" id="reassignTestsModal" tabindex="-1" aria-labelledby="reassignTestsModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header" style="background-color: #343a40; color: #fff;">
          <h5 class="modal-title" id="reassignTestsModalLabel">Reassign Tests</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Top Buttons -->
          <div class="d-flex justify-content-between mb-3">
            <button class="btn btn-secondary btn-sm btn-round" id="topCloseReassignTests">Close</button>
            <button class="btn btn-primary btn-sm btn-round" id="topReassignTests" disabled>Reassign</button>
          </div>
          
          <!-- Filters -->
          <div class="row mb-3">
            <div class="col-md-2">
              <input type="text" class="form-control" id="testIdFilter" placeholder="Search ID...">
            </div>
            <div class="col-md-2">
              <input type="text" class="form-control" id="testTitleFilter" placeholder="Search Title...">
            </div>
            <div class="col-md-2">
              <select class="form-select searchable-select" id="testVersionFilter" multiple>
                <option value="">All Versions</option>
              </select>
            </div>
            <div class="col-md-2">
              <select class="form-select searchable-select" id="testStatusFilter" multiple>
                <option value="">All Status</option>
              </select>
            </div>
            <div class="col-md-2">
              <select class="form-select searchable-select" id="testAssignedToFilter" multiple>
                <option value="">All Assigned To</option>
              </select>
            </div>
            <div class="col-md-2">
              <select class="form-select searchable-select" id="testTypeFilter" multiple>
                <option value="">All Types</option>
              </select>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-2">
              <select class="form-select searchable-select" id="testIssueTypeFilter" multiple>
                <option value="">All Issue Types</option>
              </select>
            </div>
            <div class="col-md-2">
              <select class="form-select searchable-select" id="testJiraStatusFilter" multiple>
                <option value="">All Jira Status</option>
              </select>
            </div>
            <div class="col-md-8">
              <button class="btn btn-outline-primary btn-sm me-2" id="applyTestFilters">Apply Filters</button>
              <button class="btn btn-outline-secondary btn-sm" id="clearTestFilters">Clear Filters</button>
            </div>
          </div>
          
          <!-- Reassign User Selection (Hidden until Reassign clicked) -->
          <div id="reassignUserSelection" class="mb-3 d-none">
            <label class="form-label">Select Users to Reassign</label>
            <select class="form-select searchable-select" id="reassignUsers" multiple>
              <option value="">Select Users</option>
            </select>
          </div>
          
          <!-- Table -->
          <div class="table-container">
            <table class="table table-hover table-bordered align-middle">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllTests"></th>
                  <th>ID</th>
                  <th>Title</th>
                  <th>Version</th>
                  <th>Status</th>
                  <th>Assigned To</th>
                  <th>Type</th>
                  <th>Issue Type</th>
                  <th>Jira Status</th>
                </tr>
              </thead>
              <tbody id="testsTableBody"></tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <button class="btn btn-sm btn-outline-primary" id="testFirstPage"><i class="bi bi-skip-start-fill"></i> First</button>
              <button class="btn btn-sm btn-outline-secondary" id="testPrevPage"><i class="bi bi-caret-left-fill"></i> Prev</button>
              <button class="btn btn-sm btn-outline-secondary" id="testNextPage">Next <i class="bi bi-caret-right-fill"></i></button>
              <button class="btn btn-sm btn-outline-primary" id="testLastPage">Last <i class="bi bi-skip-end-fill"></i></button>
            </div>
            <div id="testPaginationStatus" class="text-muted small"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm btn-round" id="bottomCloseReassignTests">Close</button>
          <button class="btn btn-primary btn-sm btn-round" id="bottomReassignTests" disabled>Reassign</button>
        </div>
      </div>
    </div>
  </div>
  
  
  
  
  
    <!-- Loading Modal for Reassignment -->
  <div class="modal fade" id="reassignLoadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <h5 class="modal-title fw-semibold">Reassigning Tests, please wait...</h5>
      </div>
    </div>
  </div>
  
  
  
  
  
  
  
  
  <!-- Update View MCR Modal with _reassign suffix -->
<div class="modal fade" id="viewMCRModal_reassign" tabindex="-1" aria-labelledby="viewMCRModalLabel_reassign" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="viewMCRModalLabel_reassign">Reassign Tests</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Filters -->
        <div class="row mb-3">
          <div class="col-md-3">
            <input type="text" class="form-control" id="reassignIdFilter_reassign" placeholder="Search ID">
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control" id="reassignTitleFilter_reassign" placeholder="Search Title">
          </div>
          <div class="col-md-3">
            <select class="form-select" id="reassignVersionFilter_reassign" multiple data-placeholder="Select Version">
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="reassignStatusFilter_reassign" multiple data-placeholder="Select Status">
            </select>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-3">
            <select class="form-select" id="reassignAssignedToFilter_reassign" data-placeholder="Select Assigned To">
              <option value="">All</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="reassignTypeFilter_reassign" data-placeholder="Select Type">
              <option value="">All</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="reassignIssueTypeFilter_reassign" data-placeholder="Select Issue Type">
              <option value="">All</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="reassignJiraStatusFilter_reassign" data-placeholder="Select Jira Status">
              <option value="">All</option>
            </select>
          </div>
        </div>
        <!-- Top Buttons -->
        <div class="d-flex justify-content-between mb-2">
          <div>
            <button class="btn btn-secondary btn-sm btn-round" data-bs-dismiss="modal">
              <i class="bi bi-x-circle"></i> Close
            </button>
            <button class="btn btn-danger btn-sm btn-round reassign-btn" style="display: none;">
              <i class="bi bi-x-circle"></i> Reassign
            </button>
          </div>
          <div>
            <input type="checkbox" id="selectAllTests_reassign"> <label for="selectAllTests_reassign">Select All</label>
          </div>
        </div>
        <!-- Tests Table -->
        <div style="max-height: 400px; overflow-y: auto;">
          <table class="table table-hover table-bordered">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllTestsHeader_reassign"></th>
                <th>ID</th>
                <th>Title</th>
                <th>Version</th>
                <th>Status</th>
                <th>Assigned To</th>
                <th>Type</th>
                <th>Issue Type</th>
                <th>Jira Status</th>
              </tr>
            </thead>
            <tbody id="reassignTestsTableBody_reassign"></tbody>
          </table>
        </div>
        <!-- Pagination -->
        <div class="d-flex justify-content-between mt-2">
          <span id="reassignPaginationStatus_reassign"></span>
          <div>
            <button class="btn btn-sm btn-outline-danger btn-round" id="reassignFirstPage_reassign">First</button>
            <button class="btn btn-sm btn-outline-danger btn-round" id="reassignPrevPage_reassign">Previous</button>
            <button class="btn btn-sm btn-outline-danger btn-round" id="reassignNextPage_reassign">Next</button>
            <button class="btn btn-sm btn-outline-danger btn-round" id="reassignLastPage_reassign">Last</button>
          </div>
        </div>
        <!-- Bottom Buttons -->
        <div class="d-flex justify-content-between mt-2">
          <div>
            <button class="btn btn-secondary btn-sm btn-round" data-bs-dismiss="modal">
              <i class="bi bi-x-circle"></i> Close
            </button>
            <button class="btn btn-danger btn-sm btn-round reassign-btn" style="display: none;">
              <i class="bi bi-x-circle"></i> Reassign
            </button>
          </div>
        </div>
        <!-- Reassign Users Selection (hidden until Reassign clicked) -->
        <div id="reassignUsersSection_reassign" class="mt-3" style="display: none;">
          <h6>Select Users to Reassign</h6>
          <select class="form-select" id="reassignUsersSelect_reassign" multiple data-placeholder="Select Users">
          </select>
          <button class="btn btn-danger btn-sm btn-round mt-2" id="confirmReassignBtn_reassign">
            <i class="bi bi-x-circle"></i> Confirm Reassignment
          </button>
        </div>
      </div>
    </div>
  </div>
</div>


  
  
  
  
  
  
  
  
<!-- Add Reassign Tests Ports Modal -->
<div class="modal fade" id="reassignTestsPortsModal" tabindex="-1" aria-labelledby="reassignTestsPortsModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #343a40; color: #fff;">
        <h5 class="modal-title" id="reassignTestsPortsModalLabel">Reassign Tests Ports</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <button type="button" class="btn btn-primary" id="reassignTestsPortsActionTop">Reassign</button>
          <button type="button" class="btn btn-secondary ms-2" data-bs-dismiss="modal">Close</button>
        </div>
        <div class="row mb-3">
          <div class="col-md-2">
            <input type="text" class="form-control" id="portsIdFilter" placeholder="Search ID...">
          </div>
          <div class="col-md-2">
            <input type="text" class="form-control" id="portsTitleFilter" placeholder="Search Title...">
          </div>
          <div class="col-md-2">
            <select class="form-select searchable-select" id="portsVersionFilter" multiple>
              <option value="">All Versions</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select searchable-select" id="portsStatusFilter" multiple>
              <option value="">All Status</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select searchable-select" id="portsAssignedToFilter" multiple>
              <option value="">All Assigned To</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select searchable-select" id="portsTypeFilter" multiple>
              <option value="">All Types</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select searchable-select" id="portsIssueTypeFilter" multiple>
              <option value="">All Issue Types</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select searchable-select" id="portsJiraStatusFilter" multiple>
              <option value="">All Jira Status</option>
            </select>
          </div>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <button class="btn btn-sm btn-outline-primary" id="portsFirstPage"><i class="bi bi-skip-start-fill"></i> First</button>
            <button class="btn btn-sm btn-outline-secondary" id="portsPrevPage"><i class="bi bi-caret-left-fill"></i> Prev</button>
            <button class="btn btn-sm btn-outline-secondary" id="portsNextPage">Next <i class="bi bi-caret-right-fill"></i></button>
            <button class="btn btn-sm btn-outline-primary" id="portsLastPage">Last <i class="bi bi-skip-end-fill"></i></button>
          </div>
          <div id="portsPaginationStatus" class="text-muted small"></div>
        </div>
        <div class="table-container">
          <table class="table table-hover table-bordered align-middle">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllTestsPorts"></th>
                <th>ID</th>
                <th>Title</th>
                <th>Version</th>
                <th>Status</th>
                <th>Assigned To</th>
                <th>Type</th>
                <th>Issue Type</th>
                <th>Jira Status</th>
              </tr>
            </thead>
            <tbody id="testsPortsTableBody"></tbody>
          </table>
        </div>
        <div class="mb-3">
          <select class="form-select searchable-select" id="reassignToUsersPorts" multiple style="display: none;">
            <option value="">Select Users</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="reassignTestsPortsActionBottom">Reassign</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

  
  
  
  
  <!-- Tests Summary Modal starts -->
<div class="modal fade" id="testsSummaryModal" tabindex="-1" aria-labelledby="testsSummaryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #343a40; color: #fff;">
        <h5 class="modal-title" id="testsSummaryModalLabel">Tests Summary</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="table-container">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Lead</th>
                <th>Not Started</th>
                <th>In Progress</th>
                <th>On Hold</th>
                <th>Completed</th>
                <th class="total-column">Total</th>
              </tr>
            </thead>
            <tbody id="testsSummaryTableBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
  <!-- Tests Summary Modal ends -->
  
  
  
  
  
  

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>
  <script>
  let testsSummaryModal;
	let tests = [];
    let filteredTests = [];
    let testCurrentPage = 1;
    const testPageSize = 50;
    let reassignTestsModal;
    let reassignLoadingModal;

    
  
    
 // Initialize modal on DOM load
  document.addEventListener('DOMContentLoaded', function() {
    reassignTestsModal = new bootstrap.Modal(document.getElementById('reassignTestsModal'), { backdrop: 'static', keyboard: false });
    reassignLoadingModal = new bootstrap.Modal(document.getElementById('reassignLoadingModal'));
	
    
	testsSummaryModal = new bootstrap.Modal(document.getElementById('testsSummaryModal'));
  const testsSummaryButton = document.getElementById('testsSummary');
  if (testsSummaryButton) {
    testsSummaryButton.addEventListener('click', openTestsSummaryModal);
  } else {
    console.error('Tests Summary button not found. Please ensure <button id="testsSummary"> exists in the filter-button-table.');
  }
	
	
    document.getElementById('reassignTests').addEventListener('click', openReassignTestsModal);
    document.getElementById('topCloseReassignTests').addEventListener('click', () => reassignTestsModal.hide());
    document.getElementById('bottomCloseReassignTests').addEventListener('click', () => reassignTestsModal.hide());
    document.getElementById('topReassignTests').addEventListener('click', showReassignUsers);
    document.getElementById('bottomReassignTests').addEventListener('click', showReassignUsers);
    document.getElementById('applyTestFilters').addEventListener('click', applyTestFilters);
    document.getElementById('clearTestFilters').addEventListener('click', clearTestFilters);
    document.getElementById('selectAllTests').addEventListener('change', toggleSelectAllTests);
    document.getElementById('testFirstPage').addEventListener('click', () => { testCurrentPage = 1; renderTestsTable(); });
    document.getElementById('testPrevPage').addEventListener('click', () => { if (testCurrentPage > 1) testCurrentPage--; renderTestsTable(); });
    document.getElementById('testNextPage').addEventListener('click', () => {
      const totalPages = Math.ceil(filteredTests.length / testPageSize);
      if (testCurrentPage < totalPages) testCurrentPage++; renderTestsTable();
    });
    document.getElementById('testLastPage').addEventListener('click', () => {
      testCurrentPage = Math.ceil(filteredTests.length / testPageSize); renderTestsTable();
    });
    
    // Initialize Select2 for filters
    $('#testVersionFilter, #testStatusFilter, #testAssignedToFilter, #testTypeFilter, #testIssueTypeFilter, #testJiraStatusFilter').select2({
      theme: 'bootstrap-5',
      width: '100%',
      dropdownParent: $('#reassignTestsModal'),
      placeholder: 'Select...',
      allowClear: true
    });
  });
  
  async function openReassignTestsModal() {
    await fetchTests();
    await populateTestFilters();
    filteredTests = [...tests];
    testCurrentPage = 1;
    document.getElementById('testIdFilter').value = '';
    document.getElementById('testTitleFilter').value = '';
    $('#testVersionFilter, #testStatusFilter, #testAssignedToFilter, #testTypeFilter, #testIssueTypeFilter, #testJiraStatusFilter').val(null).trigger('change');
    document.getElementById('reassignUserSelection').classList.add('d-none');
    document.getElementById('topReassignTests').disabled = true;
    document.getElementById('bottomReassignTests').disabled = true;
    renderTestsTable();
    reassignTestsModal.show();
  }
  
  async function fetchTests() {
    reassignLoadingModal.show();
    try {
      const response = await fetch('https://demo.defectdojo.org/api/v2/tests/?tags=crm_jira&engagement__status=In%20Progress', {
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.getElementById('csrfToken').value
        }
      });
      if (response.ok) {
        const data = await response.json();
        tests = data.results;
        await enrichTestsWithLeadNames(tests);
      } else {
        showToast('Failed to fetch tests', 'error');
      }
    } catch (error) {
      console.error('Error fetching tests:', error);
      showToast('Error fetching tests', 'error');
    } finally {
      reassignLoadingModal.hide();
    }
  }
  
  async function enrichTestsWithLeadNames(tests) {
    await fetchAllUsers();
    tests.forEach(t => {
      t.lead = t.lead ? String(t.lead) : '';
      t.lead_name = t.lead && usersCache[t.lead] ? usersCache[t.lead].name : 'Unassigned';
    });
  }
  
  async function populateTestFilters() {
    const versionFilter = document.getElementById('testVersionFilter');
    const statusFilter = document.getElementById('testStatusFilter');
    const assignedToFilter = document.getElementById('testAssignedToFilter');
    const typeFilter = document.getElementById('testTypeFilter');
    const issueTypeFilter = document.getElementById('testIssueTypeFilter');
    const jiraStatusFilter = document.getElementById('testJiraStatusFilter');
    
    versionFilter.innerHTML = '<option value="">All Versions</option>';
    statusFilter.innerHTML = '<option value="">All Status</option>';
    assignedToFilter.innerHTML = '<option value="">All Assigned To</option>';
    typeFilter.innerHTML = '<option value="">All Types</option>';
    issueTypeFilter.innerHTML = '<option value="">All Issue Types</option>';
    jiraStatusFilter.innerHTML = '<option value="">All Jira Status</option>';
    
    const versions = [...new Set(tests.map(t => t.version).filter(v => v))];
    const statuses = [...new Set(tests.map(t => t.commit_hash).filter(s => s))];
    const leads = [...new Set(tests.map(t => t.lead).filter(l => l))];
    const types = [...new Set(tests.map(t => t.test_type_name).filter(t => t))];
    const issueTypes = [...new Set(tests.map(t => t.build_id).filter(i => i))];
    const jiraStatuses = [...new Set(tests.map(t => t.branch_tag).filter(j => j))];
    
    versions.forEach(v => {
      const option = document.createElement('option');
      option.value = v;
      option.textContent = v;
      versionFilter.appendChild(option);
    });
    
    statuses.forEach(s => {
      const option = document.createElement('option');
      option.value = s;
      option.textContent = s;
      statusFilter.appendChild(option);
    });
    
    leads.forEach(l => {
      const option = document.createElement('option');
      option.value = l;
      option.textContent = usersCache[l]?.name || l;
      assignedToFilter.appendChild(option);
    });
    
    types.forEach(t => {
      const option = document.createElement('option');
      option.value = t;
      option.textContent = t;
      typeFilter.appendChild(option);
    });
    
    issueTypes.forEach(i => {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = i;
      issueTypeFilter.appendChild(option);
    });
    
    jiraStatuses.forEach(j => {
      const option = document.createElement('option');
      option.value = j;
      option.textContent = j;
      jiraStatusFilter.appendChild(option);
    });
  }
  
  function applyTestFilters() {
    const idFilter = document.getElementById('testIdFilter').value;
    const titleFilter = document.getElementById('testTitleFilter').value.toLowerCase();
    const versionFilter = $('#testVersionFilter').val() || [];
    const statusFilter = $('#testStatusFilter').val() || [];
    const assignedToFilter = $('#testAssignedToFilter').val() || [];
    const typeFilter = $('#testTypeFilter').val() || [];
    const issueTypeFilter = $('#testIssueTypeFilter').val() || [];
    const jiraStatusFilter = $('#testJiraStatusFilter').val() || [];
    
    filteredTests = tests.filter(t => {
      if (idFilter && t.id.toString() !== idFilter) return false;
      if (titleFilter && !t.title.toLowerCase().includes(titleFilter)) return false;
      if (versionFilter.length && !versionFilter.includes(t.version)) return false;
      if (statusFilter.length && !statusFilter.includes(t.commit_hash)) return false;
      if (assignedToFilter.length && !assignedToFilter.includes(t.lead)) return false;
      if (typeFilter.length && !typeFilter.includes(t.test_type_name)) return false;
      if (issueTypeFilter.length && !issueTypeFilter.includes(t.build_id)) return false;
      if (jiraStatusFilter.length && !jiraStatusFilter.includes(t.branch_tag)) return false;
      return true;
    });
    
    testCurrentPage = 1;
    renderTestsTable();
  }
  
  function clearTestFilters() {
    document.getElementById('testIdFilter').value = '';
    document.getElementById('testTitleFilter').value = '';
    $('#testVersionFilter, #testStatusFilter, #testAssignedToFilter, #testTypeFilter, #testIssueTypeFilter, #testJiraStatusFilter').val(null).trigger('change');
    filteredTests = [...tests];
    testCurrentPage = 1;
    renderTestsTable();
  }
  
  function renderTestsTable() {
    const start = (testCurrentPage - 1) * testPageSize;
    const pagedData = filteredTests.slice(start, start + testPageSize);
    const totalPages = Math.ceil(filteredTests.length / testPageSize);
    
    const tableBody = document.getElementById('testsTableBody');
    if (tableBody) {
      tableBody.innerHTML = pagedData.map(t => `
        <tr>
          <td><input type="checkbox" class="test-checkbox" data-id="${t.id}"></td>
          <td>${t.id}</td>
          <td>${t.title}</td>
          <td>${t.version || ''}</td>
          <td>${t.commit_hash || ''}</td>
          <td>${t.lead_name}</td>
          <td>${t.test_type_name || ''}</td>
          <td>${t.build_id || ''}</td>
          <td>${t.branch_tag || ''}</td>
        </tr>
      `).join('');
    } else {
      console.error('Table body element not found');
    }
    
    document.getElementById('testPaginationStatus').textContent = `Page ${testCurrentPage} of ${totalPages} (${filteredTests.length} results)`;
    document.getElementById('testPrevPage').disabled = testCurrentPage === 1;
    document.getElementById('testFirstPage').disabled = testCurrentPage === 1;
    document.getElementById('testNextPage').disabled = testCurrentPage === totalPages;
    document.getElementById('testLastPage').disabled = testCurrentPage === totalPages;
    
    document.querySelectorAll('.test-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', updateReassignButtonState);
    });
    
    document.getElementById('selectAllTests').checked = false;
  }
  
  function toggleSelectAllTests(e) {
    const checkboxes = document.querySelectorAll('.test-checkbox');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
    updateReassignButtonState();
  }
  
  function updateReassignButtonState() {
    const checked = document.querySelectorAll('.test-checkbox:checked').length > 0;
    document.getElementById('topReassignTests').disabled = !checked;
    document.getElementById('bottomReassignTests').disabled = !checked;
  }
  
  async function showReassignUsers() {
    const reassignUserSelection = document.getElementById('reassignUserSelection');
    const reassignUsersSelect = document.getElementById('reassignUsers');
    
    reassignUserSelection.classList.remove('d-none');
    reassignUsersSelect.innerHTML = '<option value="">Select Users</option>';
    
    await fetchAllUsers();
    Object.values(usersCache).forEach(user => {
      const option = document.createElement('option');
      option.value = user.id;
      option.textContent = user.name;
      reassignUsersSelect.appendChild(option);
    });
    
    $('#reassignUsers').select2({
      theme: 'bootstrap-5',
      width: '100%',
      dropdownParent: $('#reassignTestsModal'),
      placeholder: 'Select Users',
      allowClear: true
    });
    
    $('#reassignUsers').off('change').on('change', reassignSelectedTests);
  }
  
  async function reassignSelectedTests() {
    const selectedTestIds = Array.from(document.querySelectorAll('.test-checkbox:checked')).map(cb => parseInt(cb.getAttribute('data-id')));
    const selectedUserIds = $('#reassignUsers').val();
    
    if (!selectedTestIds.length || !selectedUserIds.length) {
      showToast('Please select tests and users to reassign', 'error');
      return;
    }
    
    reassignLoadingModal.show();
    try {
      for (const testId of selectedTestIds) {
        const payload = { lead: selectedUserIds[0] }; // Assign to first selected user
        const response = await fetch(`https://demo.defectdojo.org/api/v2/tests/${testId}/`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.getElementById('csrfToken').value
          },
          body: JSON.stringify(payload)
        });
        
        if (response.ok) {
          const updatedTest = await response.json();
          const index = tests.findIndex(t => t.id === testId);
          if (index !== -1) {
            tests[index].lead = String(updatedTest.lead);
            tests[index].lead_name = usersCache[updatedTest.lead]?.name || 'Unassigned';
          }
        } else {
          showToast('Failed to reassign some tests', 'error');
        }
      }
      
      filteredTests = [...tests];
      applyTestFilters();
      document.getElementById('reassignUserSelection').classList.add('d-none');
      $('#reassignUsers').val(null).trigger('change');
      showToast('Tests reassigned successfully', 'success');
    } catch (error) {
      console.error('Error reassigning tests:', error);
      showToast('Error reassigning tests', 'error');
    } finally {
      reassignLoadingModal.hide();
    }
  } 
  
  
  
  
  
    const pageSize = 15;
    const closedPageSize = 20;
    let allEngagements = [];
    let filteredEngagements = [];
    let closedEngagements = [];
    let completedEngagements = [];
    let currentPage = 1;
    let closedCurrentPage = 1;
    let usersCache = {};
    let productsCache = {};
    let engagementToClose = null;
	let addJirasModal;
let viewJirasModal;
let jiraTests = [];
let filteredJiraTests = [];
let jiraCurrentPage = 1;
const jiraPageSize = 5;
// Add variables
  let riskRegisterModal;
let currentEngagementId;




let reassignmentModal;
  let reassignEngagements = [];
  let filteredReassignEngagements = [];
  
  
  let reassignTests = [];
let filteredReassignTests = [];
let reassignCurrentPage = 1;
const reassignPageSize = 50;






let reassignTests_reassign = [];
let filteredReassignTests_reassign = [];
let reassignCurrentPage_reassign = 1;
const reassignPageSize_reassign = 50;

async function fetchReassignTests_reassign() {
  loadingModal.show();
  try {
    const response = await fetch('https://demo.defectdojo.org/api/v2/tests/?tags=crm_jira&limit=100000', {
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.getElementById('csrfToken').value
      }
    });
    if (response.ok) {
      const data = await response.json();
      reassignTests_reassign = data.results.filter(test => {
        const engagement = allEngagements.find(e => e.id === test.engagement);
        return engagement && engagement.status !== 'Closed';
      }).map(test => ({
        id: test.id,
        title: test.title,
        version: test.version || '',
        status: test.commit_hash || '',
        assigned_to: test.lead || '',
        type: test.test_type || '',
        issue_type: test.build_id || '',
        jira_status: test.branch_tag || ''
      }));
      filteredReassignTests_reassign = [...reassignTests_reassign];
      initializeFilters_reassign();
      renderReassignTable_reassign();
    }
  } catch (error) {
    console.error('Error fetching tests:', error);
    showToast('Error fetching tests', 'error');
  } finally {
    loadingModal.hide();
  }
}

function initializeFilters_reassign() {
  const versions_reassign = [...new Set(reassignTests_reassign.map(t => t.version).filter(v => v))];
  const statuses_reassign = [...new Set(reassignTests_reassign.map(t => t.status).filter(s => s))];
  const assignedTos_reassign = [...new Set(reassignTests_reassign.map(t => t.assigned_to).filter(a => a))];
  const types_reassign = [...new Set(reassignTests_reassign.map(t => t.type).filter(t => t))];
  const issueTypes_reassign = [...new Set(reassignTests_reassign.map(t => t.issue_type).filter(i => i))];
  const jiraStatuses_reassign = [...new Set(reassignTests_reassign.map(t => t.jira_status).filter(j => j))];

  $('#reassignVersionFilter_reassign').select2({
    theme: 'bootstrap-5',
    width: '100%',
    placeholder: 'Select Version',
    data: versions_reassign.map(v => ({ id: v, text: v })),
    allowClear: true
  });

  $('#reassignStatusFilter_reassign').select2({
    theme: 'bootstrap-5',
    width: '100%',
    placeholder: 'Select Status',
    data: statuses_reassign.map(s => ({ id: s, text: s })),
    allowClear: true
  });

  $('#reassignAssignedToFilter_reassign').select2({
    theme: 'bootstrap-5',
    width: '100%',
    placeholder: 'Select Assigned To',
    data: [{ id: '', text: 'All' }, ...assignedTos_reassign.map(a => ({ id: a, text: usersCache[a]?.name || a }))],
    allowClear: true
  });

  $('#reassignTypeFilter_reassign').select2({
    theme: 'bootstrap-5',
    width: '100%',
    placeholder: 'Select Type',
    data: [{ id: '', text: 'All' }, ...types_reassign.map(t => ({ id: t, text: t }))],
    allowClear: true
  });

  $('#reassignIssueTypeFilter_reassign').select2({
    theme: 'bootstrap-5',
    width: '100%',
    placeholder: 'Select Issue Type',
    data: [{ id: '', text: 'All' }, ...issueTypes_reassign.map(i => ({ id: i, text: i }))],
    allowClear: true
  });

  $('#reassignJiraStatusFilter_reassign').select2({
    theme: 'bootstrap-5',
    width: '100%',
    placeholder: 'Select Jira Status',
    data: [{ id: '', text: 'All' }, ...jiraStatuses_reassign.map(j => ({ id: j, text: j }))],
    allowClear: true
  });

  // Filter event listeners
  $('#reassignIdFilter_reassign').on('input', applyReassignFilters_reassign);
  $('#reassignTitleFilter_reassign').on('input', applyReassignFilters_reassign);
  $('#reassignVersionFilter_reassign').on('change', applyReassignFilters_reassign);
  $('#reassignStatusFilter_reassign').on('change', applyReassignFilters_reassign);
  $('#reassignAssignedToFilter_reassign').on('change', applyReassignFilters_reassign);
  $('#reassignTypeFilter_reassign').on('change', applyReassignFilters_reassign);
  $('#reassignIssueTypeFilter_reassign').on('change', applyReassignFilters_reassign);
  $('#reassignJiraStatusFilter_reassign').on('change', applyReassignFilters_reassign);
}

function applyReassignFilters_reassign() {
  const idFilter_reassign = $('#reassignIdFilter_reassign').val().toLowerCase();
  const titleFilter_reassign = $('#reassignTitleFilter_reassign').val().toLowerCase();
  const versionFilter_reassign = $('#reassignVersionFilter_reassign').val() || [];
  const statusFilter_reassign = $('#reassignStatusFilter_reassign').val() || [];
  const assignedToFilter_reassign = $('#reassignAssignedToFilter_reassign').val();
  const typeFilter_reassign = $('#reassignTypeFilter_reassign').val();
  const issueTypeFilter_reassign = $('#reassignIssueTypeFilter_reassign').val();
  const jiraStatusFilter_reassign = $('#reassignJiraStatusFilter_reassign').val();

  filteredReassignTests_reassign = reassignTests_reassign.filter(test => {
    return (!idFilter_reassign || String(test.id).includes(idFilter_reassign)) &&
           (!titleFilter_reassign || test.title.toLowerCase().includes(titleFilter_reassign)) &&
           (versionFilter_reassign.length === 0 || versionFilter_reassign.includes(test.version)) &&
           (statusFilter_reassign.length === 0 || statusFilter_reassign.includes(test.status)) &&
           (!assignedToFilter_reassign || test.assigned_to === assignedToFilter_reassign) &&
           (!typeFilter_reassign || test.type === typeFilter_reassign) &&
           (!issueTypeFilter_reassign || test.issue_type === issueTypeFilter_reassign) &&
           (!jiraStatusFilter_reassign || test.jira_status === jiraStatusFilter_reassign);
  });

  reassignCurrentPage_reassign = 1;
  renderReassignTable_reassign();
}

function renderReassignTable_reassign() {
  const start_reassign = (reassignCurrentPage_reassign - 1) * reassignPageSize_reassign;
  const pagedData_reassign = filteredReassignTests_reassign.slice(start_reassign, start_reassign + reassignPageSize_reassign);
  const totalPages_reassign = Math.ceil(filteredReassignTests_reassign.length / reassignPageSize_reassign);

  const tableBody_reassign = document.getElementById('reassignTestsTableBody_reassign');
  tableBody_reassign.innerHTML = pagedData_reassign.map(t => `
    <tr>
      <td><input type="checkbox" class="test-checkbox" data-id="${t.id}"></td>
      <td>${t.id}</td>
      <td>${t.title}</td>
      <td>${t.version}</td>
      <td>${t.status}</td>
      <td>${usersCache[t.assigned_to]?.name || t.assigned_to}</td>
      <td>${t.type}</td>
      <td>${t.issue_type}</td>
      <td>${t.jira_status}</td>
    </tr>
  `).join('');

  document.getElementById('reassignPaginationStatus_reassign').textContent = `Page ${reassignCurrentPage_reassign} of ${totalPages_reassign} (${filteredReassignTests_reassign.length} results)`;
  document.getElementById('reassignPrevPage_reassign').disabled = reassignCurrentPage_reassign === 1;
  document.getElementById('reassignFirstPage_reassign').disabled = reassignCurrentPage_reassign === 1;
  document.getElementById('reassignNextPage_reassign').disabled = reassignCurrentPage_reassign === totalPages_reassign;
  document.getElementById('reassignLastPage_reassign').disabled = reassignCurrentPage_reassign === totalPages_reassign;

  // Checkbox event listeners
  const checkboxes_reassign = document.querySelectorAll('.test-checkbox');
  const selectAll_reassign = document.getElementById('selectAllTests_reassign');
  const selectAllHeader_reassign = document.getElementById('selectAllTestsHeader_reassign');
  const reassignButtons_reassign = document.querySelectorAll('.reassign-btn');

  checkboxes_reassign.forEach(cb => {
    cb.addEventListener('change', () => {
      const anyChecked_reassign = Array.from(checkboxes_reassign).some(c => c.checked);
      reassignButtons_reassign.forEach(btn => btn.style.display = anyChecked_reassign ? 'inline-block' : 'none');
      selectAll_reassign.checked = Array.from(checkboxes_reassign).every(c => c.checked);
      selectAllHeader_reassign.checked = selectAll_reassign.checked;
    });
  });

  selectAll_reassign.addEventListener('change', () => {
    checkboxes_reassign.forEach(cb => cb.checked = selectAll_reassign.checked);
    selectAllHeader_reassign.checked = selectAll_reassign.checked;
    reassignButtons_reassign.forEach(btn => btn.style.display = selectAll_reassign.checked ? 'inline-block' : 'none');
  });

  selectAllHeader_reassign.addEventListener('change', () => {
    selectAll_reassign.checked = selectAllHeader_reassign.checked;
    checkboxes_reassign.forEach(cb => cb.checked = selectAllHeader_reassign.checked);
    reassignButtons_reassign.forEach(btn => btn.style.display = selectAllHeader_reassign.checked ? 'inline-block' : 'none');
  });

  // Pagination event listeners
  document.getElementById('reassignPrevPage_reassign').addEventListener('click', () => {
    if (reassignCurrentPage_reassign > 1) {
      reassignCurrentPage_reassign--;
      renderReassignTable_reassign();
    }
  });

  document.getElementById('reassignFirstPage_reassign').addEventListener('click', () => {
    reassignCurrentPage_reassign = 1;
    renderReassignTable_reassign();
  });

  document.getElementById('reassignNextPage_reassign').addEventListener('click', () => {
    if (reassignCurrentPage_reassign < totalPages_reassign) {
      reassignCurrentPage_reassign++;
      renderReassignTable_reassign();
    }
  });

  document.getElementById('reassignLastPage_reassign').addEventListener('click', () => {
    reassignCurrentPage_reassign = totalPages_reassign;
    renderReassignTable_reassign();
  });

  // Reassign button event listener
  reassignButtons_reassign.forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('reassignUsersSection_reassign').style.display = 'block';
      initializeUsersSelect_reassign();
    });
  });
}

function initializeUsersSelect_reassign() {
  const usersSelect_reassign = $('#reassignUsersSelect_reassign');
  if (usersSelect_reassign.hasClass('select2-hidden-accessible')) {
    usersSelect_reassign.select2('destroy');
  }
  usersSelect_reassign.select2({
    theme: 'bootstrap-5',
    width: '100%',
    placeholder: 'Select Users',
    data: Object.values(usersCache).map(user => ({
      id: user.id,
      text: `${user.first_name} ${user.last_name}`
    })),
    allowClear: true
  });

  document.getElementById('confirmReassignBtn_reassign').addEventListener('click', async () => {
    const selectedTests_reassign = Array.from(document.querySelectorAll('.test-checkbox:checked')).map(cb => parseInt(cb.getAttribute('data-id')));
    const selectedUsers_reassign = $('#reassignUsersSelect_reassign').val();

    if (selectedTests_reassign.length === 0 || selectedUsers_reassign.length === 0) {
      showToast('Please select tests and users to reassign', 'error');
      return;
    }

    loadingModal.show();
    try {
      for (const testId of selectedTests_reassign) {
        for (const userId of selectedUsers_reassign) {
          await fetch(`https://demo.defectdojo.org/api/v2/tests/${testId}/`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.getElementById('csrfToken').value
            },
            body: JSON.stringify({ lead: userId })
          });
        }
      }
      showToast('Tests reassigned successfully', 'success');
      document.getElementById('reassignUsersSection_reassign').style.display = 'none';
      $('#reassignUsersSelect_reassign').val(null).trigger('change');
      document.querySelectorAll('.test-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('selectAllTests_reassign').checked = false;
      document.getElementById('selectAllTestsHeader_reassign').checked = false;
      document.querySelectorAll('.reassign-btn').forEach(btn => btn.style.display = 'none');
      fetchReassignTests_reassign();
    } catch (error) {
      console.error('Error reassigning tests:', error);
      showToast('Error reassigning tests', 'error');
    } finally {
      loadingModal.hide();
    }
  });
}

// Initialize modal on open
$('#viewMCRModal_reassign').on('show.bs.modal', () => {
  fetchReassignTests_reassign();
});

// Clean up select2 on modal close
$('#viewMCRModal_reassign').on('hidden.bs.modal', () => {
  $('#reassignVersionFilter_reassign, #reassignStatusFilter_reassign, #reassignAssignedToFilter_reassign, #reassignTypeFilter_reassign, #reassignIssueTypeFilter_reassign, #reassignJiraStatusFilter_reassign, #reassignUsersSelect_reassign').each(function() {
    if ($(this).hasClass('select2-hidden-accessible')) {
      $(this).select2('destroy');
    }
  });
  document.getElementById('reassignUsersSection_reassign').style.display = 'none';
});
















async function fetchReassignTests() {
  loadingModal.show();
  try {
    const response = await fetch('https://demo.defectdojo.org/api/v2/tests/?tags=crm_jira&limit=1000', {
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.getElementById('csrfToken').value
      }
    });
    if (response.ok) {
      const data = await response.json();
      reassignTests = data.results.filter(test => {
        const engagement = allEngagements.find(e => e.id === test.engagement);
        return engagement && engagement.status !== 'Closed';
      }).map(test => ({
        id: test.id,
        title: test.title,
        version: test.version || '',
        status: test.commit_hash || '',
        assigned_to: test.lead || '',
        type: test.test_type || '',
        issue_type: test.build_id || '',
        jira_status: test.branch_tag || ''
      }));
      filteredReassignTests = [...reassignTests];
      initializeFilters();
      renderReassignTable();
    }
  } catch (error) {
    console.error('Error fetching tests:', error);
    showToast('Error fetching tests', 'error');
  } finally {
    loadingModal.hide();
  }
}

function initializeFilters() {
  const versions = [...new Set(reassignTests.map(t => t.version).filter(v => v))];
  const statuses = [...new Set(reassignTests.map(t => t.status).filter(s => s))];
  const assignedTos = [...new Set(reassignTests.map(t => t.assigned_to).filter(a => a))];
  const types = [...new Set(reassignTests.map(t => t.type).filter(t => t))];
  const issueTypes = [...new Set(reassignTests.map(t => t.issue_type).filter(i => i))];
  const jiraStatuses = [...new Set(reassignTests.map(t => t.jira_status).filter(j => j))];

  $('#reassignVersionFilter').select2({
    theme: 'bootstrap-5',
    width: '100%',
    placeholder: 'Select Version',
    data: versions.map(v => ({ id: v, text: v })),
    allowClear: true
  });

  $('#reassignStatusFilter').select2({
    theme: 'bootstrap-5',
    width: '100%',
    placeholder: 'Select Status',
    data: statuses.map(s => ({ id: s, text: s })),
    allowClear: true
  });

  $('#reassignAssignedToFilter').select2({
    theme: 'bootstrap-5',
    width: '100%',
    placeholder: 'Select Assigned To',
    data: [{ id: '', text: 'All' }, ...assignedTos.map(a => ({ id: a, text: usersCache[a]?.name || a }))],
    allowClear: true
  });

  $('#reassignTypeFilter').select2({
    theme: 'bootstrap-5',
    width: '100%',
    placeholder: 'Select Type',
    data: [{ id: '', text: 'All' }, ...types.map(t => ({ id: t, text: t }))],
    allowClear: true
  });

  $('#reassignIssueTypeFilter').select2({
    theme: 'bootstrap-5',
    width: '100%',
    placeholder: 'Select Issue Type',
    data: [{ id: '', text: 'All' }, ...issueTypes.map(i => ({ id: i, text: i }))],
    allowClear: true
  });

  $('#reassignJiraStatusFilter').select2({
    theme: 'bootstrap-5',
    width: '100%',
    placeholder: 'Select Jira Status',
    data: [{ id: '', text: 'All' }, ...jiraStatuses.map(j => ({ id: j, text: j }))],
    allowClear: true
  });

  // Filter event listeners
  $('#reassignIdFilter').on('input', applyReassignFilters);
  $('#reassignTitleFilter').on('input', applyReassignFilters);
  $('#reassignVersionFilter').on('change', applyReassignFilters);
  $('#reassignStatusFilter').on('change', applyReassignFilters);
  $('#reassignAssignedToFilter').on('change', applyReassignFilters);
  $('#reassignTypeFilter').on('change', applyReassignFilters);
  $('#reassignIssueTypeFilter').on('change', applyReassignFilters);
  $('#reassignJiraStatusFilter').on('change', applyReassignFilters);
}

function applyReassignFilters() {
  const idFilter = $('#reassignIdFilter').val().toLowerCase();
  const titleFilter = $('#reassignTitleFilter').val().toLowerCase();
  const versionFilter = $('#reassignVersionFilter').val() || [];
  const statusFilter = $('#reassignStatusFilter').val() || [];
  const assignedToFilter = $('#reassignAssignedToFilter').val();
  const typeFilter = $('#reassignTypeFilter').val();
  const issueTypeFilter = $('#reassignIssueTypeFilter').val();
  const jiraStatusFilter = $('#reassignJiraStatusFilter').val();

  filteredReassignTests = reassignTests.filter(test => {
    return (!idFilter || String(test.id).includes(idFilter)) &&
           (!titleFilter || test.title.toLowerCase().includes(titleFilter)) &&
           (versionFilter.length === 0 || versionFilter.includes(test.version)) &&
           (statusFilter.length === 0 || statusFilter.includes(test.status)) &&
           (!assignedToFilter || test.assigned_to === assignedToFilter) &&
           (!typeFilter || test.type === typeFilter) &&
           (!issueTypeFilter || test.issue_type === issueTypeFilter) &&
           (!jiraStatusFilter || test.jira_status === jiraStatusFilter);
  });

  reassignCurrentPage = 1;
  renderReassignTable();
}

function renderReassignTable() {
  const start = (reassignCurrentPage - 1) * reassignPageSize;
  const pagedData = filteredReassignTests.slice(start, start + reassignPageSize);
  const totalPages = Math.ceil(filteredReassignTests.length / reassignPageSize);

  const tableBody = document.getElementById('reassignTestsTableBody');
  tableBody.innerHTML = pagedData.map(t => `
    <tr>
      <td><input type="checkbox" class="test-checkbox" data-id="${t.id}"></td>
      <td>${t.id}</td>
      <td>${t.title}</td>
      <td>${t.version}</td>
      <td>${t.status}</td>
      <td>${usersCache[t.assigned_to]?.name || t.assigned_to}</td>
      <td>${t.type}</td>
      <td>${t.issue_type}</td>
      <td>${t.jira_status}</td>
    </tr>
  `).join('');

  document.getElementById('reassignPaginationStatus').textContent = `Page ${reassignCurrentPage} of ${totalPages} (${filteredReassignTests.length} results)`;
  document.getElementById('reassignPrevPage').disabled = reassignCurrentPage === 1;
  document.getElementById('reassignFirstPage').disabled = reassignCurrentPage === 1;
  document.getElementById('reassignNextPage').disabled = reassignCurrentPage === totalPages;
  document.getElementById('reassignLastPage').disabled = reassignCurrentPage === totalPages;

  // Checkbox event listeners
  const checkboxes = document.querySelectorAll('.test-checkbox');
  const selectAll = document.getElementById('selectAllTests');
  const selectAllHeader = document.getElementById('selectAllTestsHeader');
  const reassignButtons = document.querySelectorAll('.reassign-btn');

  checkboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      const anyChecked = Array.from(checkboxes).some(c => c.checked);
      reassignButtons.forEach(btn => btn.style.display = anyChecked ? 'inline-block' : 'none');
      selectAll.checked = Array.from(checkboxes).every(c => c.checked);
      selectAllHeader.checked = selectAll.checked;
    });
  });

  selectAll.addEventListener('change', () => {
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    selectAllHeader.checked = selectAll.checked;
    reassignButtons.forEach(btn => btn.style.display = selectAll.checked ? 'inline-block' : 'none');
  });

  selectAllHeader.addEventListener('change', () => {
    selectAll.checked = selectAllHeader.checked;
    checkboxes.forEach(cb => cb.checked = selectAllHeader.checked);
    reassignButtons.forEach(btn => btn.style.display = selectAllHeader.checked ? 'inline-block' : 'none');
  });

  // Pagination event listeners
  document.getElementById('reassignPrevPage').addEventListener('click', () => {
    if (reassignCurrentPage > 1) {
      reassignCurrentPage--;
      renderReassignTable();
    }
  });

  document.getElementById('reassignFirstPage').addEventListener('click', () => {
    reassignCurrentPage = 1;
    renderReassignTable();
  });

  document.getElementById('reassignNextPage').addEventListener('click', () => {
    if (reassignCurrentPage < totalPages) {
      reassignCurrentPage++;
      renderReassignTable();
    }
  });

  document.getElementById('reassignLastPage').addEventListener('click', () => {
    reassignCurrentPage = totalPages;
    renderReassignTable();
  });

  // Reassign button event listener
  reassignButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('reassignUsersSection').style.display = 'block';
      initializeUsersSelect();
    });
  });
}

function initializeUsersSelect() {
  const usersSelect = $('#reassignUsersSelect');
  if (usersSelect.hasClass('select2-hidden-accessible')) {
    usersSelect.select2('destroy');
  }
  usersSelect.select2({
    theme: 'bootstrap-5',
    width: '100%',
    placeholder: 'Select Users',
    data: Object.values(usersCache).map(user => ({
      id: user.id,
      text: `${user.first_name} ${user.last_name}`
    })),
    allowClear: true
  });

  document.getElementById('confirmReassignBtn').addEventListener('click', async () => {
    const selectedTests = Array.from(document.querySelectorAll('.test-checkbox:checked')).map(cb => parseInt(cb.getAttribute('data-id')));
    const selectedUsers = $('#reassignUsersSelect').val();

    if (selectedTests.length === 0 || selectedUsers.length === 0) {
      showToast('Please select tests and users to reassign', 'error');
      return;
    }

    loadingModal.show();
    try {
      for (const testId of selectedTests) {
        for (const userId of selectedUsers) {
          await fetch(`https://demo.defectdojo.org/api/v2/tests/${testId}/`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.getElementById('csrfToken').value
            },
            body: JSON.stringify({ lead: userId })
          });
        }
      }
      showToast('Tests reassigned successfully', 'success');
      document.getElementById('reassignUsersSection').style.display = 'none';
      $('#reassignUsersSelect').val(null).trigger('change');
      document.querySelectorAll('.test-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('selectAllTests').checked = false;
      document.getElementById('selectAllTestsHeader').checked = false;
      document.querySelectorAll('.reassign-btn').forEach(btn => btn.style.display = 'none');
      fetchReassignTests();
    } catch (error) {
      console.error('Error reassigning tests:', error);
      showToast('Error reassigning tests', 'error');
    } finally {
      loadingModal.hide();
    }
  });
}

// Initialize modal on open
$('#reassignTestsModal').on('show.bs.modal', () => {
  fetchReassignTests();
});

// Clean up select2 on modal close
$('#reassignTestsModal').on('hidden.bs.modal', () => {
  $('#reassignVersionFilter, #reassignStatusFilter, #reassignAssignedToFilter, #reassignTypeFilter, #reassignIssueTypeFilter, #reassignJiraStatusFilter, #reassignUsersSelect').each(function() {
    if ($(this).hasClass('select2-hidden-accessible')) {
      $(this).select2('destroy');
    }
  });
  document.getElementById('reassignUsersSection').style.display = 'none';
});
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  let viewMCRModal;
let mcrTests = [];
let filteredMCRTests = [];
let mcrCurrentPage = 1;
const mcrPageSize = 20;
let environmentsCache = {};

document.addEventListener('DOMContentLoaded', function() {
  viewMCRModal = new bootstrap.Modal(document.getElementById('viewMCRModal'), { backdrop: 'static', keyboard: false });
  const viewJirasBtn = document.getElementById('viewJiras');
  if (viewJirasBtn) {
    viewJirasBtn.removeEventListener('click', openViewJirasModal);
    viewJirasBtn.addEventListener('click', openViewMCRModal);
  }
  const viewMCRBtn = document.getElementById('viewMCR');
  if (viewMCRBtn) {
    viewMCRBtn.addEventListener('click', openViewMCRModal);
  }
  const refreshMCRBtn = document.getElementById('refreshMCRData');
  if (refreshMCRBtn) {
    refreshMCRBtn.addEventListener('click', refreshMCRData);
  }
});

async function openViewMCRModal() {
  try {
    mcrTests = [];
    filteredMCRTests = [];
    mcrCurrentPage = 1;
    document.getElementById('mcrTitleSearch').value = '';
    $('#mcrVersionFilter').val('').trigger('change');
    document.getElementById('mcrStatusFilter').value = '';
    $('#mcrAssignedToFilter').val('').trigger('change');
    document.getElementById('mcrTypeFilter').value = '';
    document.getElementById('mcrIssueTypeFilter').value = '';
    document.getElementById('mcrJiraStatusFilter').value = '';
    document.getElementById('mcrTableBody').innerHTML = '';
    await fetchMCRTests();
    await populateMCREngagementSelect();
    viewMCRModal.show();
  } catch (error) {
    console.error('Error opening MCR modal:', error);
    showToast('Failed to open MCR modal', 'error');
  }
}

async function refreshMCRData() {
  try {
    const engagementId = $('#mcrEngagementSelect').val();
    mcrTests = [];
    filteredMCRTests = [];
    mcrCurrentPage = 1;
    document.getElementById('mcrTableBody').innerHTML = '';
    await fetchMCRTests(engagementId);
    await populateMCREngagementSelect();
    applyMCRFilters();
    showToast('Data refreshed successfully', 'success');
  } catch (error) {
    console.error('Error refreshing MCR data:', error);
    showToast('Failed to refresh data', 'error');
  }
}

async function populateMCREngagementSelect() {
  try {
    const engagementSelect = document.getElementById('mcrEngagementSelect');
    engagementSelect.innerHTML = '<option value="">Select a Patch</option>';
    
    const response = await fetch('https://demo.defectdojo.org/api/v2/engagements/?active=true');
    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status}`);
    }
    const data = await response.json();
    const engagements = data.results || [];
    
    engagements.forEach(e => {
      const option = document.createElement('option');
      option.value = e.id;
      option.textContent = `${e.id} - ${e.name}`;
      engagementSelect.appendChild(option);
    });

    $('#mcrEngagementSelect').select2({
      theme: 'bootstrap-5',
      width: '100%',
      dropdownParent: $('#viewMCRModal'),
      placeholder: 'Select a Patch',
      allowClear: true
    });

    $('#mcrEngagementSelect').off('change').on('change', async function() {
      const engagementId = $(this).val();
      await fetchMCRTests(engagementId);
      applyMCRFilters();
    });
  } catch (error) {
    console.error('Error populating engagement select:', error);
    showToast('MCR Jiras Open ', 'success');
  }
}

async function populateMCRStatusFilter() {
  try {
    const statusFilter = document.getElementById('mcrStatusFilter');
    statusFilter.innerHTML = '<option value="">All Status</option>';
    const statuses = [...new Set(mcrTests.map(t => t.branch_tag).filter(s => s))].sort();
    statuses.forEach(status => {
      const option = document.createElement('option');
      option.value = status;
      option.textContent = status;
      statusFilter.appendChild(option);
    });
  } catch (error) {
    console.error('Error populating status filter:', error);
    showToast('Failed to populate status filter', 'error');
  }
}

async function populateMCRAssignedToFilter() {
  try {
    const assignedToFilter = document.getElementById('mcrAssignedToFilter');
    assignedToFilter.innerHTML = '<option value="">All Assigned To</option>';
    const assignedTos = [...new Set(mcrTests.map(t => t.lead_name).filter(a => a && a !== 'Unassigned'))].sort();
    assignedTos.forEach(name => {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      assignedToFilter.appendChild(option);
    });

    $('#mcrAssignedToFilter').select2({
      theme: 'bootstrap-5',
      width: '100%',
      dropdownParent: $('#viewMCRModal'),
      placeholder: 'All Assigned To',
      allowClear: true
    });
  } catch (error) {
    console.error('Error populating assigned to filter:', error);
    showToast('Failed to populate assigned to filter', 'error');
  }
}

async function populateMCRVersionFilter() {
  try {
    const versionFilter = document.getElementById('mcrVersionFilter');
    versionFilter.innerHTML = '<option value="">All Versions</option>';
    const versions = [...new Set(mcrTests.map(t => t.version).filter(v => v))].sort();
    versions.forEach(version => {
      const option = document.createElement('option');
      option.value = version;
      option.textContent = version;
      versionFilter.appendChild(option);
    });

    $('#mcrVersionFilter').select2({
      theme: 'bootstrap-5',
      width: '100%',
      dropdownParent: $('#viewMCRModal'),
      placeholder: 'All Versions',
      allowClear: true
    });
  } catch (error) {
    console.error('Error populating version filter:', error);
    showToast('Failed to populate version filter', 'error');
  }
}

async function populateMCRTypeFilter() {
  try {
    const typeFilter = document.getElementById('mcrTypeFilter');
    typeFilter.innerHTML = '<option value="">All Types</option>';
    const types = [...new Set(mcrTests.map(t => t.type_name).filter(t => t && t !== 'Unknown'))].sort();
    types.forEach(type => {
      const option = document.createElement('option');
      option.value = type;
      option.textContent = type;
      typeFilter.appendChild(option);
    });
  } catch (error) {
    console.error('Error populating type filter:', error);
    showToast('Failed to populate type filter', 'error');
  }
}

async function populateMCRIssueTypeFilter() {
  try {
    const issueTypeFilter = document.getElementById('mcrIssueTypeFilter');
    issueTypeFilter.innerHTML = '<option value="">All Issue Types</option>';
    const issueTypes = [...new Set(mcrTests.map(t => t.commit_hash).filter(it => it))].sort();
    issueTypes.forEach(issueType => {
      const option = document.createElement('option');
      option.value = issueType;
      option.textContent = issueType;
      issueTypeFilter.appendChild(option);
    });
  } catch (error) {
    console.error('Error populating issue type filter:', error);
    showToast('Failed to populate issue type filter', 'error');
  }
}

async function populateMCRJiraStatusFilter() {
  try {
    const jiraStatusFilter = document.getElementById('mcrJiraStatusFilter');
    jiraStatusFilter.innerHTML = '<option value="">All Jira Status</option>';
    const jiraStatuses = [...new Set(mcrTests.map(t => t.build_id).filter(js => js))].sort();
    jiraStatuses.forEach(status => {
      const option = document.createElement('option');
      option.value = status;
      option.textContent = status;
      jiraStatusFilter.appendChild(option);
    });
  } catch (error) {
    console.error('Error populating Jira status filter:', error);
    showToast('Failed to populate Jira status filter', 'error');
  }
}

async function fetchEnvironments() {
  if (Object.keys(environmentsCache).length === 0) {
    try {
      const response = await fetch('https://demo.defectdojo.org/api/v2/development_environments/', {
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.getElementById('csrfToken').value
        }
      });
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      const data = await response.json();
      data.results.forEach(env => {
        environmentsCache[env.id] = { id: env.id, name: env.name };
      });
    } catch (error) {
      console.error('Error fetching environments:', error);
      showToast('Failed to fetch environments', 'error');
    }
  }
}

async function fetchMCRTests(engagementId = null) {
  loadingModal.show();
  try {
    let activeEngagementIds = [];
    
    if (!engagementId) {
      const engagementsResponse = await fetch('https://demo.defectdojo.org/api/v2/engagements/?active=true');
      if (!engagementsResponse.ok) {
        throw new Error(`HTTP error fetching engagements! Status: ${engagementsResponse.status}`);
      }
      const engagementsData = await engagementsResponse.json();
      activeEngagementIds = engagementsData.results.map(e => e.id);
    } else {
      activeEngagementIds = [engagementId];
    }

    const testPromises = activeEngagementIds.map(id => 
      fetch(`https://demo.defectdojo.org/api/v2/tests/?engagement=${id}&tags=crm_jira`, {
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.getElementById('csrfToken').value
        }
      }).then(res => res.json())
    );

    const testsData = await Promise.all(testPromises);
    mcrTests = testsData.flatMap(data => data.results || []);
    
    await enrichMCRWithLeadNames(mcrTests);
    filteredMCRTests = [...mcrTests];
    
    await Promise.all([
      populateMCRStatusFilter(),
      populateMCRAssignedToFilter(),
      populateMCRTypeFilter(),
      populateMCRVersionFilter(),
      populateMCRIssueTypeFilter(),
      populateMCRJiraStatusFilter()
    ]);
    
    renderMCRTable();
  } catch (error) {
    console.error('Error fetching MCR tests:', error);
    showToast(`Error fetching MCR tests: ${error.message || 'Server unavailable'}`, 'error');
  } finally {
    loadingModal.hide();
  }
}

async function enrichMCRWithLeadNames(tests) {
  try {
    await Promise.all([fetchAllUsers(), fetchEnvironments()]);
    tests.forEach(t => {
      t.lead = t.lead ? String(t.lead) : '';
      t.lead_name = t.lead && usersCache[t.lead] ? usersCache[t.lead].name : 'Unassigned';
      t.type_name = t.environment && environmentsCache[t.environment] ? environmentsCache[t.environment].name : 'Unknown';
    });
  } catch (error) {
    console.error('Error enriching MCR tests:', error);
    showToast('Failed to enrich test data', 'error');
  }
}

function applyMCRFilters() {
  try {
    const titleSearch = document.getElementById('mcrTitleSearch').value.toLowerCase();
    const versionFilter = $('#mcrVersionFilter').val();
    const statusFilter = document.getElementById('mcrStatusFilter').value;
    const assignedToFilter = $('#mcrAssignedToFilter').val();
    const typeFilter = document.getElementById('mcrTypeFilter').value;
    const issueTypeFilter = document.getElementById('mcrIssueTypeFilter').value;
    const jiraStatusFilter = document.getElementById('mcrJiraStatusFilter').value;

    filteredMCRTests = mcrTests.filter(test => {
      const title = test.title && typeof test.title === 'string' ? test.title.toLowerCase() : '';
      return (
        (!titleSearch || title.includes(titleSearch)) &&
        (!versionFilter || test.version === versionFilter) &&
        (!statusFilter || test.branch_tag === statusFilter) &&
        (!assignedToFilter || test.lead_name === assignedToFilter) &&
        (!typeFilter || test.type_name === typeFilter) &&
        (!issueTypeFilter || test.commit_hash === issueTypeFilter) &&
        (!jiraStatusFilter || test.build_id === jiraStatusFilter)
      );
    });

    mcrCurrentPage = 1;
    renderMCRTable();
  } catch (error) {
    console.error('Error applying MCR filters:', error);
    showToast('Failed to apply filters', 'error');
  }
}

function clearMCRFilters() {
  try {
    document.getElementById('mcrTitleSearch').value = '';
    $('#mcrVersionFilter').val('').trigger('change');
    document.getElementById('mcrStatusFilter').value = '';
    $('#mcrAssignedToFilter').val('').trigger('change');
    document.getElementById('mcrTypeFilter').value = '';
    document.getElementById('mcrIssueTypeFilter').value = '';
    document.getElementById('mcrJiraStatusFilter').value = '';
    filteredMCRTests = [...mcrTests];
    mcrCurrentPage = 1;
    renderMCRTable();
  } catch (error) {
    console.error('Error clearing MCR filters:', error);
    showToast('Failed to clear filters', 'error');
  }
}

function renderMCRTable() {
  try {
    const start = (mcrCurrentPage - 1) * mcrPageSize;
    const pagedData = filteredMCRTests.slice(start, start + mcrPageSize);
    const totalPages = Math.ceil(filteredMCRTests.length / mcrPageSize);

    const mcrTableBody = document.getElementById('mcrTableBody');
    mcrTableBody.innerHTML = pagedData.map(t => `
      <tr>
        <td>${t.id}</td>
        <td>${escapeHtml(t.title)}</td>
        <td><textarea class="form-control" data-id="${t.id}" data-field="description">${escapeHtml(t.description || '')}</textarea></td>
        <td>${escapeHtml(t.version || '')}</td>
        <td>
          <select class="form-select" data-id="${t.id}" data-field="branch_tag">
            <option value="Not Started" ${t.branch_tag === 'Not Started' ? 'selected' : ''}>Not Started</option>
            <option value="In Progress" ${t.branch_tag === 'In Progress' ? 'selected' : ''}>In Progress</option>
            <option value="On Hold" ${t.branch_tag === 'On Hold' ? 'selected' : ''}>On Hold</option>
            <option value="Completed" ${t.branch_tag === 'Completed' ? 'selected' : ''}>Completed</option>
          </select>
        </td>
        <td>
          <select class="form-select searchable-select" data-id="${t.id}" data-field="lead">
            <option value="" ${!t.lead ? 'selected' : ''}>Unassigned</option>
            ${Object.values(usersCache)
              .sort((a, b) => a.name.localeCompare(b.name))
              .map(user => `
                <option value="${user.id}" ${t.lead === String(user.id) ? 'selected' : ''}>${escapeHtml(user.name)}</option>
              `).join('')}
          </select>
        </td>
        <td>${escapeHtml(t.type_name)}</td>
        <td><input type="text" class="form-control" data-id="${t.id}" data-field="commit_hash" value="${escapeHtml(t.commit_hash || '')}"></td>
        <td><input type="text" class="form-control" data-id="${t.id}" data-field="build_id" value="${escapeHtml(t.build_id || '')}"></td>
        <td>
          <button class="btn btn-sm btn-primary save-mcr-btn" data-id="${t.id}" title="Save"><i class="bi bi-save"></i></button>
        </td>
      </tr>
    `).join('');

    document.getElementById('mcrPaginationStatus').textContent = `Page ${mcrCurrentPage} of ${totalPages} (${filteredMCRTests.length} results)`;
    document.getElementById("mcrPrevPage").disabled = mcrCurrentPage === 1;
    document.getElementById("mcrFirstPage").disabled = mcrCurrentPage === 1;
    document.getElementById("mcrNextPage").disabled = mcrCurrentPage === totalPages;
    document.getElementById("mcrLastPage").disabled = mcrCurrentPage === totalPages;

    $('#mcrTableBody .searchable-select').each(function() {
      if ($(this).hasClass('select2-hidden-accessible')) {
        $(this).select2('destroy');
      }
    });

    $('#mcrTableBody .searchable-select').select2({
      theme: 'bootstrap-5',
      width: '100%',
      dropdownParent: $('#viewMCRModal'),
      placeholder: 'Unassigned',
      allowClear: true
    });

    mcrTableBody.querySelectorAll('.save-mcr-btn').forEach(button => {
      button.removeEventListener('click', handleSaveMCR);
      button.addEventListener('click', handleSaveMCR);
    });
  } catch (error) {
    console.error('Error rendering MCR table:', error);
    showToast('Failed to render table', 'error');
  }
}

function handleSaveMCR(event) {
  try {
    const testId = parseInt(event.currentTarget.getAttribute('data-id'));
    const row = event.currentTarget.closest('tr');
    const description = row.querySelector(`textarea[data-field="description"]`).value;
    const branchTag = row.querySelector(`select[data-field="branch_tag"]`).value;
    const lead = row.querySelector(`select[data-field="lead"]`).value;
    const commitHash = row.querySelector(`input[data-field="commit_hash"]`).value;
    const buildId = row.querySelector(`input[data-field="build_id"]`).value;
    saveMCRTest(testId, { description, branch_tag: branchTag, lead, commit_hash: commitHash, build_id: buildId });
  } catch (error) {
    console.error('Error handling save MCR:', error);
    showToast('Failed to save test', 'error');
  }
}

async function saveMCRTest(testId, updates) {
  try {
    const payload = {};
    if ('description' in updates) payload.description = updates.description;
    if ('branch_tag' in updates) payload.branch_tag = updates.branch_tag;
    if ('lead' in updates) payload.lead = updates.lead ? parseInt(updates.lead) : null;
    if ('commit_hash' in updates) payload.commit_hash = updates.commit_hash;
    if ('build_id' in updates) payload.build_id = updates.build_id;

    const response = await fetch(`https://demo.defectdojo.org/api/v2/tests/${testId}/`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.getElementById('csrfToken').value
      },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.message || 'Unknown error');
    }

    const updatedTest = await response.json();
    const index = mcrTests.findIndex(t => t.id === testId);
    if (index !== -1) {
      mcrTests[index] = { ...mcrTests[index], ...updatedTest };
      mcrTests[index].lead = updatedTest.lead ? String(updatedTest.lead) : '';
      mcrTests[index].lead_name = updatedTest.lead && usersCache[updatedTest.lead] ? usersCache[updatedTest.lead].name : 'Unassigned';
      filteredMCRTests = [...mcrTests];
      applyMCRFilters();
      showToast('MCR test updated successfully', 'success');
    }
  } catch (error) {
    console.error('Error saving MCR test:', error);
    showToast(`Failed to update MCR test: ${error.message || 'Unknown error'}`, 'error');
  }
}

document.getElementById("mcrFirstPage").onclick = () => { mcrCurrentPage = 1; renderMCRTable(); };
document.getElementById("mcrPrevPage").onclick = () => { if (mcrCurrentPage > 1) mcrCurrentPage--; renderMCRTable(); };
document.getElementById("mcrNextPage").onclick = () => {
  const totalPages = Math.ceil(filteredMCRTests.length / mcrPageSize);
  if (mcrCurrentPage < totalPages) mcrCurrentPage++; renderMCRTable();
};
document.getElementById("mcrLastPage").onclick = () => {
  mcrCurrentPage = Math.ceil(filteredMCRTests.length / mcrPageSize); renderMCRTable();
};

document.getElementById('applyMCRFilters').addEventListener('click', applyMCRFilters);
document.getElementById('clearMCRFilters').addEventListener('click', clearMCRFilters);

function escapeHtml(unsupported) {
  if (!unsupported) return '';
  return unsupported
    .toString()
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}
  
  
  
  
  
  
  
  
  
  
  

  // Update DOMContentLoaded
  document.addEventListener('DOMContentLoaded', function() {
    reassignmentModal = new bootstrap.Modal(document.getElementById('reassignmentModal'), { backdrop: 'static', keyboard: false });
    document.getElementById('reassignEngagements').addEventListener('click', openReassignmentModal);
    document.getElementById('applyReassignFilters').addEventListener('click', applyReassignFilters);
    document.getElementById('clearReassignFilters').addEventListener('click', clearReassignFilters);
    document.getElementById('selectAllReassign').addEventListener('change', toggleSelectAllReassign);
    document.getElementById('reassignLeads').addEventListener('click', reassignLeads);
	
	bulkCloseModal = new bootstrap.Modal(document.getElementById('bulkCloseModal'), { backdrop: 'static', keyboard: false });
      document.getElementById('bulkCloseEngagements').addEventListener('click', openBulkCloseModal);
      document.getElementById('applyBulkCloseFilters').addEventListener('click', applyBulkCloseFilters);
      document.getElementById('clearBulkCloseFilters').addEventListener('click', clearBulkCloseFilters);
      document.getElementById('selectAllBulkClose').addEventListener('change', toggleSelectAllBulkClose);
      document.getElementById('bulkCloseAction').addEventListener('click', bulkCloseSelectedEngagements);

	
	
	
	
	
  });




async function openBulkCloseModal() {
      await fetchBulkCloseData();
      await populateBulkCloseFilters();
      filteredBulkCloseEngagements = [...bulkCloseEngagements];
      renderBulkCloseTable();
      bulkCloseModal.show();
    }

    async function fetchBulkCloseData() {
      loadingModal.show();
      try {
        const response = await fetch('https://demo.defectdojo.org/api/v2/engagements/?tags=pci&active=true');
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        bulkCloseEngagements = data.results;
        await enrichBulkCloseWithNames(bulkCloseEngagements);
      } catch (error) {
        console.error('Error fetching bulk close data:', error);
        showToast(`Failed to fetch engagements: ${error.message || 'Server unavailable'}`, 'error');
      } finally {
        loadingModal.hide();
      }
    }

    async function enrichBulkCloseWithNames(engagements) {
      await fetchAllUsers();
      await fetchAllProducts();
      engagements.forEach(e => {
        e.lead_name = e.lead ? usersCache[e.lead]?.name || 'Unassigned' : 'Unassigned';
        e.product_name = e.product ? productsCache[e.product]?.name || 'Unknown' : 'Unknown';
      });
    }

    async function populateBulkCloseFilters() {
      const nameFilter = document.getElementById('bulkCloseNameFilter');
      nameFilter.innerHTML = '<option value="">All Patch Names</option>';
      const uniqueNames = [...new Set(bulkCloseEngagements.map(e => e.name))].sort();
      uniqueNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        nameFilter.appendChild(option);
      });

      const productFilter = document.getElementById('bulkCloseProductFilter');
      productFilter.innerHTML = '<option value="">All Products</option>';
      Object.values(productsCache).forEach(product => {
        const option = document.createElement('option');
        option.value = product.id;
        option.textContent = product.name;
        productFilter.appendChild(option);
      });

      const leadFilter = document.getElementById('bulkCloseLeadFilter');
      leadFilter.innerHTML = '<option value="">All Leads</option>';
      Object.values(usersCache).forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = user.name;
        leadFilter.appendChild(option);
      });

      $('#bulkCloseNameFilter').select2({
        theme: 'bootstrap-5',
        width: '100%',
        dropdownParent: $('#bulkCloseModal'),
        placeholder: 'All Patch Names',
        allowClear: true,
        dropdownCssClass: 'select2-dropdown-wide'
      });

      $('#bulkCloseProductFilter').select2({
        theme: 'bootstrap-5',
        width: '100%',
        dropdownParent: $('#bulkCloseModal'),
        placeholder: 'All Products',
        allowClear: true,
        closeOnSelect: false,
        dropdownCssClass: 'select2-dropdown-wide'
      });

      $('#bulkCloseLeadFilter').select2({
        theme: 'bootstrap-5',
        width: '100%',
        dropdownParent: $('#bulkCloseModal'),
        placeholder: 'All Leads',
        allowClear: true,
        closeOnSelect: false,
        dropdownCssClass: 'select2-dropdown-wide'
      });
    }

    function applyBulkCloseFilters() {
      const idFilter = document.getElementById('bulkCloseIdFilter').value.toLowerCase();
      const nameFilter = $('#bulkCloseNameFilter').val();
      const statusFilter = document.getElementById('bulkCloseStatusFilter').value;
      const productFilter = $('#bulkCloseProductFilter').val() || [];
      const leadFilter = $('#bulkCloseLeadFilter').val() || [];

      filteredBulkCloseEngagements = bulkCloseEngagements.filter(e => {
        const matchesId = !idFilter || e.id.toString().includes(idFilter);
        const matchesName = !nameFilter || e.name === nameFilter;
        const matchesStatus = !statusFilter || e.status === statusFilter;
        const matchesProduct = productFilter.length === 0 || productFilter.includes(e.product.toString());
        const matchesLead = leadFilter.length === 0 || leadFilter.includes(e.lead?.toString());

        return matchesId && matchesName && matchesStatus && matchesProduct && matchesLead;
      });

      renderBulkCloseTable();
    }

    function clearBulkCloseFilters() {
      document.getElementById('bulkCloseIdFilter').value = '';
      $('#bulkCloseNameFilter').val(null).trigger('change');
      document.getElementById('bulkCloseStatusFilter').value = '';
      $('#bulkCloseProductFilter').val(null).trigger('change');
      $('#bulkCloseLeadFilter').val(null).trigger('change');
      filteredBulkCloseEngagements = [...bulkCloseEngagements];
      renderBulkCloseTable();
    }

    function toggleSelectAllBulkClose() {
      const isChecked = document.getElementById('selectAllBulkClose').checked;
      document.querySelectorAll('#bulkCloseTableBody input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = isChecked;
      });
    }

    function renderBulkCloseTable() {
      const tableBody = document.getElementById('bulkCloseTableBody');
      tableBody.innerHTML = filteredBulkCloseEngagements.map(e => `
        <tr>
          <td><input type="checkbox" class="bulk-close-checkbox" data-id="${e.id}"></td>
          <td>${e.id}</td>
          <td>${e.name}</td>
          <td>${e.commit_hash}</td>
          <td>${e.build_id}</td>
		  <td>${e.branch_tag}</td>
          <td>${e.lead_name}</td>
        </tr>
      `).join('');
    }

    async function bulkCloseSelectedEngagements() {
  const selectedIds = Array.from(document.querySelectorAll('#bulkCloseTableBody .bulk-close-checkbox:checked'))
    .map(checkbox => parseInt(checkbox.getAttribute('data-id')));

  if (selectedIds.length === 0) {
    showToast('Please select at least one engagement to close', 'error');
    return;
  }

  loadingModal.show();
  try {
    const closePromises = selectedIds.map(async id => {
      const response = await fetch(`https://demo.defectdojo.org/api/v2/engagements/${id}/close/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.getElementById('csrfToken').value
        }
      });

      if (!response.ok) {
        // Attempt to get error details from the response
        const contentType = response.headers.get('Content-Type');
        let errorMessage = `Failed to close engagement ${id} (Status: ${response.status})`;
        if (contentType && contentType.includes('application/json')) {
          const errorData = await response.json();
          errorMessage += `: ${errorData.message || JSON.stringify(errorData)}`;
        } else {
          const text = await response.text();
          errorMessage += `: ${text || 'No additional details'}`;
        }
        throw new Error(errorMessage);
      }

      // Only parse JSON if the response has a body (not 204)
      if (response.status !== 204 && response.headers.get('Content-Length') !== '0') {
        return response.json();
      }
      return { id }; // Return a minimal object if no body
    });

    const results = await Promise.all(closePromises);

    // Update local data
    selectedIds.forEach(id => {
      const index = allEngagements.findIndex(e => e.id === id);
      if (index !== -1) {
        const closedEngagement = allEngagements.splice(index, 1)[0];
        closedEngagements.push(closedEngagement);
      }
      const filteredIndex = filteredEngagements.findIndex(e => e.id === id);
      if (filteredIndex !== -1) {
        filteredEngagements.splice(filteredIndex, 1);
      }
      const bulkIndex = bulkCloseEngagements.findIndex(e => e.id === id);
      if (bulkIndex !== -1) {
        bulkCloseEngagements.splice(bulkIndex, 1);
      }
      const filteredBulkIndex = filteredBulkCloseEngagements.findIndex(e => e.id === id);
      if (filteredBulkIndex !== -1) {
        filteredBulkCloseEngagements.splice(filteredBulkIndex, 1);
      }
    });

    updateStatusCounts();
    renderTable();
    renderClosedTable();
    renderBulkCloseTable();
    showToast(`${selectedIds.length} engagement(s) closed successfully`, 'success');
    bulkCloseModal.hide();
  } catch (error) {
    console.error('Error during bulk close:', error);
    showToast(`Error closing engagements: ${error.message}`, 'error');
  } finally {
    loadingModal.hide();
  }
}










<!-- Actual Reassignment code starts -->
async function openReassignmentModal() {
  await fetchReassignmentData();
  await populateReassignFilters();
  filteredReassignEngagements = [...reassignEngagements];
  renderReassignmentTable();
  reassignmentModal.show();
}

async function fetchReassignmentData() {
  loadingModal.show();
  try {
    // First fetch active engagements
    const engagementsResponse = await fetch('https://demo.defectdojo.org/api/v2/engagements/?active=true');
    if (!engagementsResponse.ok) {
      throw new Error(`HTTP error fetching engagements! Status: ${engagementsResponse.status}`);
    }
    const engagementsData = await engagementsResponse.json();
    const activeEngagementIds = engagementsData.results.map(e => e.id);

    // Fetch tests for active engagements
    const testPromises = activeEngagementIds.map(id => 
      fetch(`https://demo.defectdojo.org/api/v2/tests/?engagement=${id}&tags=crm_jira`)
        .then(res => res.json())
    );
    
    const testsData = await Promise.all(testPromises);
    reassignEngagements = testsData.flatMap(data => data.results);
    
    await enrichReassignWithNames(reassignEngagements);
  } catch (error) {
    console.error('Error fetching reassignment data:', error);
    showToast(`Failed to fetch engagements: ${error.message || 'Server unavailable'}`, 'error');
  } finally {
    loadingModal.hide();
  }
}

async function enrichReassignWithNames(engagements) {
  try {
    await Promise.all([fetchAllUsers(), fetchAllProducts(), fetchAllEnvironments()]);
    
    engagements.forEach(e => {
      e.lead_name = e.lead ? usersCache[e.lead]?.name || 'Unassigned' : 'Unassigned';
      e.product_name = e.commit_hash ? productsCache[e.commit_hash]?.name || 'Unknown' : 'Unknown';
      e.environment_name = e.environment ? environmentsCache[e.environment]?.name || 'Unknown' : 'Unknown';
    });
  } catch (error) {
    console.error('Error enriching data:', error);
    showToast('Failed to enrich engagement data', 'error');
  }
}

async function fetchAllEnvironments() {
  try {
    const response = await fetch('https://demo.defectdojo.org/api/v2/development_environments/');
    if (!response.ok) {
      throw new Error(`HTTP error fetching environments! Status: ${response.status}`);
    }
    const data = await response.json();
    environmentsCache = data.results.reduce((acc, env) => {
      acc[env.id] = env;
      return acc;
    }, {});
  } catch (error) {
    console.error('Error fetching environments:', error);
    throw error;
  }
}

async function populateReassignFilters() {
  try {
    // Name Filter
    const nameFilter = document.getElementById('reassignNameFilter');
    nameFilter.innerHTML = '<option value="">All Versions</option>';
    const uniqueNames = [...new Set(reassignEngagements.map(e => e.version).filter(v => v))].sort();
    uniqueNames.forEach(version => {
      const option = document.createElement('option');
      option.value = version;
      option.textContent = version;
      nameFilter.appendChild(option);
    });

    // Product Filter
    const productFilter = document.getElementById('reassignProductFilter');
    productFilter.innerHTML = '<option value="">All Products</option>';
    Object.values(productsCache)
      .sort((a, b) => a.name.localeCompare(b.name))
      .forEach(commit_hash => {
        const option = document.createElement('option');
        option.value = commit_hash.id;
        option.textContent = commit_hash.name;
        productFilter.appendChild(option);
      });

    // Lead Filter
    const leadFilter = document.getElementById('reassignLeadFilter');
    leadFilter.innerHTML = '<option value="">All Leads</option>';
    Object.values(usersCache)
      .sort((a, b) => a.name.localeCompare(b.name))
      .forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = user.name;
        leadFilter.appendChild(option);
      });

    // Initialize Select2
    const select2Options = {
      theme: 'bootstrap-5',
      width: '100%',
      dropdownParent: $('#reassignmentModal'),
      allowClear: true,
      dropdownCssClass: 'select2-dropdown-wide'
    };

    $('#reassignNameFilter').select2({
      ...select2Options,
      placeholder: 'All Patch Names'
    });

    $('#reassignProductFilter').select2({
      ...select2Options,
      placeholder: 'All Products',
      closeOnSelect: false
    });

    $('#reassignLeadFilter').select2({
      ...select2Options,
      placeholder: 'All Leads',
      closeOnSelect: false
    });
  } catch (error) {
    console.error('Error populating filters:', error);
    showToast('Failed to populate filters', 'error');
  }
}

function applyReassignFilters() {
  try {
    const idFilter = document.getElementById('reassignIdFilter').value.toLowerCase();
    const nameFilter = $('#reassignNameFilter').val();
    const statusFilter = document.getElementById('reassignStatusFilter').value;
    const productFilter = $('#reassignProductFilter').val() || [];
    const leadFilter = $('#reassignLeadFilter').val() || [];

    filteredReassignEngagements = reassignEngagements.filter(e => {
      return (
        (!idFilter || e.id.toString().includes(idFilter)) &&
        (!nameFilter || e.version === nameFilter) &&
        (!statusFilter || e.branch_tag === statusFilter) &&
        (productFilter.length === 0 || productFilter.includes(e.commit_hash?.toString())) &&
        (leadFilter.length === 0 || leadFilter.includes(e.lead?.toString()))
      );
    });

    renderReassignmentTable();
  } catch (error) {
    console.error('Error applying filters:', error);
    showToast('Failed to apply filters', 'error');
  }
}

function clearReassignFilters() {
  try {
    document.getElementById('reassignIdFilter').value = '';
    $('#reassignNameFilter').val(null).trigger('change');
    document.getElementById('reassignStatusFilter').value = '';
    $('#reassignProductFilter').val(null).trigger('change');
    $('#reassignLeadFilter').val(null).trigger('change');
    filteredReassignEngagements = [...reassignEngagements];
    renderReassignmentTable();
  } catch (error) {
    console.error('Error clearing filters:', error);
    showToast('Failed to clear filters', 'error');
  }
}

function renderReassignmentTable() {
  try {
    const tableBody = document.getElementById('reassignmentTableBody');
    tableBody.innerHTML = filteredReassignEngagements.map(e => `
      <tr>
        <td><input type="checkbox" class="reassign-checkbox" data-id="${e.id}"></td>
        <td>${e.id}</td>
        <td>${escapeHtml(e.title)}</td>
        <td>${escapeHtml(e.environment_name || '')}</td>
        <td>${escapeHtml(e.version || '')}</td>
        <td>${escapeHtml(e.commit_hash || '')}</td>
        <td>${escapeHtml(e.build_id || '')}</td>
        <td>${escapeHtml(e.branch_tag || '')}</td>
        <td>${escapeHtml(e.lead_name || '')}</td>
      </tr>
    `).join('');

    document.getElementById('selectAllReassign').checked = false;
  } catch (error) {
    console.error('Error rendering table:', error);
    showToast('Failed to render table', 'error');
  }
}

function toggleSelectAllReassign(event) {
  try {
    document.querySelectorAll('.reassign-checkbox').forEach(checkbox => {
      checkbox.checked = event.target.checked;
    });
  } catch (error) {
    console.error('Error toggling select all:', error);
    showToast('Failed to toggle selection', 'error');
  }
}

async function reassignLeads() {
  try {
    const selectedEngagements = Array.from(
      document.querySelectorAll('.reassign-checkbox:checked')
    ).map(cb => parseInt(cb.getAttribute('data-id')));

    if (!selectedEngagements.length) {
      showToast('Please select at least one engagement to reassign', 'error');
      return;
    }

    const newLeads = $('#reassignLeadFilter').val() || [];
    if (!newLeads.length) {
      showToast('Please select at least one lead to reassign to', 'error');
      return;
    }

    loadingModal.show();
    
    const updatePromises = selectedEngagements.map(async (engagementId, index) => {
      const leadId = newLeads[index % newLeads.length];
      const engagement = reassignEngagements.find(e => e.id === engagementId);
      
      try {
        showToast(`Processing ${engagementId}: ${engagement.title}`, 'info');
        
        const response = await fetch(`https://demo.defectdojo.org/api/v2/tests/${engagementId}/`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.getElementById('csrfToken').value
          },
          body: JSON.stringify({ lead: parseInt(leadId) })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Unknown error');
        }

        const updatedEngagement = await response.json();
        updateEngagementInCaches(engagementId, updatedEngagement);
        
        return { engagementId, success: true };
      } catch (error) {
        console.error(`Failed to reassign ${engagementId}:`, error);
        showToast(`Failed to reassign ${engagementId}: ${error.message}`, 'error');
        return { engagementId, success: false };
      }
    });

    const results = await Promise.all(updatePromises);
    const failedCount = results.filter(r => !r.success).length;

    showToast(
      failedCount === 0 
        ? 'Reassignment completed successfully' 
        : `Reassignment completed with ${failedCount} errors`,
      failedCount === 0 ? 'success' : 'warning'
    );

    renderReassignmentTable();
    renderTable();
  } catch (error) {
    console.error('Error reassigning leads:', error);
    showToast('Error reassigning leads', 'error');
  } finally {
    loadingModal.hide();
  }
}

function updateEngagementInCaches(engagementId, updatedEngagement) {
  const updateCache = (cache) => {
    const index = cache.findIndex(e => e.id === engagementId);
    if (index !== -1) {
      cache[index].lead = updatedEngagement.lead;
      cache[index].lead_name = usersCache[updatedEngagement.lead]?.name || 'Unassigned';
    }
  };

  updateCache(reassignEngagements);
  updateCache(filteredReassignEngagements);
  updateCache(allEngagements);
}

function escapeHtml(unsafe) {
  if (!unsafe) return '';
  return unsafe
    .toString()
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

<!-- Actual Reassignment code ends -->















document.addEventListener('DOMContentLoaded', function() {
  // Existing modal initializations (e.g., addJirasModal, etc.) should already be here
  let searchJiraModal = new bootstrap.Modal(document.getElementById('searchJiraModal'));
  document.getElementById('searchJira').addEventListener('click', openSearchJiraModal);
  document.getElementById('searchJiraGo').addEventListener('click', searchJiraTests);

  function openSearchJiraModal() {
    document.getElementById('jiraSearchInput').value = '';
    document.getElementById('searchJiraTableBody').innerHTML = '';
    searchJiraModal.show();
  }

  async function searchJiraTests() {
    const searchValue = document.getElementById('jiraSearchInput').value.trim().toLowerCase();
    if (!searchValue) {
      showToast('Please enter a search term', 'error');
      return;
    }

    loadingModal.show();
    try {
      const testsResponse = await fetch('https://demo.defectdojo.org/api/v2/tests/?tags=crm_jira&limit=10000000000', {
        headers: { 'X-CSRFToken': document.getElementById('csrfToken').value }
      });
      if (!testsResponse.ok) throw new Error('Failed to fetch tests');
      const testsData = await testsResponse.json();
      const filteredTests = testsData.results.filter(test => (test.title ?? '').toLowerCase().includes(searchValue));

      const engagementsResponse = await fetch('https://demo.defectdojo.org/api/v2/engagements/?limit=10000000000');
      const engagementsData = await engagementsResponse.json();
      const engagementsMap = new Map(engagementsData.results.map(e => [e.id, e.name]));

      const usersResponse = await fetch('https://demo.defectdojo.org/api/v2/users/?limit=10000000000');
      const usersData = await usersResponse.json();
      const usersMap = new Map(usersData.results.map(u => [u.id, `${u.first_name} ${u.last_name}`]));

      const tableBody = document.getElementById('searchJiraTableBody');
      tableBody.innerHTML = filteredTests.map(test => `
        <tr>
          <td>${test.id}</td>
          <td>${test.title || ''}</td>
          <td>${test.description || ''}</td>
          <td>${engagementsMap.get(test.engagement) || 'Unknown'}</td>
          <td>${test.lead ? usersMap.get(parseInt(test.lead)) || 'Unassigned' : 'Unassigned'}</td>
        </tr>
      `).join('');

      if (filteredTests.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No results found</td></tr>';
      }
    } catch (error) {
      console.error('Error searching Jira tests:', error);
      showToast('Error searching Jira tests', 'error');
      document.getElementById('searchJiraTableBody').innerHTML = '<tr><td colspan="5" class="text-center">Error loading data</td></tr>';
    } finally {
      loadingModal.hide();
    }
  }
});





  // Add to DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    riskRegisterModal = new bootstrap.Modal(document.getElementById('riskRegisterModal'), { backdrop: 'static', keyboard: false });
    document.getElementById('riskRegister').addEventListener('click', openRiskRegisterModal);
    document.getElementById('closeRiskModal').addEventListener('click', () => riskRegisterModal.hide());
    document.getElementById('riskModalCloseX').addEventListener('click', (e) => { e.preventDefault(); riskRegisterModal.hide(); });
    document.getElementById('createAllRiskTests').addEventListener('click', createAllRiskTests);
  });

  async function openRiskRegisterModal() {
    const engagementId = $('#reportEngagementSelect').val();
    if (!engagementId) {
      showToast('Please select a patch in the Patch Report modal first', 'error');
      return;
    }

    const engagement = allEngagements.find(e => e.id === parseInt(engagementId));
    if (!engagement) {
      showToast('Selected engagement not found', 'error');
      return;
    }

    currentEngagementId = engagementId; // Store the engagement ID for use in createAllRiskTests
    document.getElementById('riskEngagementName').textContent = `${engagement.id} - ${engagement.name}`; // Display engagement name in modal title
    riskRegisterModal.show();
  }

  async function createAllRiskTests() {
    if (!currentEngagementId) {
      showToast('No engagement selected', 'error');
      return;
    }

    const engagement = allEngagements.find(e => e.id === parseInt(currentEngagementId));
    if (!engagement) return;

    loadingModal.show();
    const today = new Date().toISOString().slice(0, 10);
    const testTemplates = [
      {
        title: "reporting_patches",
        tags: ["reporting_patches"],
        test_type_name: "Acunetix Scan",
        test_type: 33,
        environment: 7
      },
      {
        title: "SQL Injection",
        tags: ["risk_register"],
        test_type_name: "Azure Security Center Recommendations Scan",
        test_type: 44,
        environment: 6,
        build_id: "NA"
      },
      {
        title: "XSS",
        tags: ["risk_register"],
        test_type_name: "Azure Security Center Recommendations Scan",
        test_type: 44,
        environment: 6,
        build_id: "NA"
      },
      {
        title: "XXE",
        tags: ["risk_register"],
        test_type_name: "Azure Security Center Recommendations Scan",
        test_type: 44,
        environment: 6,
        build_id: "NA"
      }
    ];

    try {
      const existingTitles = await fetchExistingTests(currentEngagementId);
      let createdCount = 0;

      for (const testData of testTemplates) {
        if (existingTitles.includes(testData.title)) {
          showToast(`Test "${testData.title}" already exists for this engagement`, 'error');
          continue;
        }

        const payload = {
          title: testData.title,
          tags: testData.tags,
          target_start: today,
          target_end: today,
          lead: engagement.lead || null,
          test_type_name: testData.test_type_name,
          test_type: testData.test_type,
          environment: testData.environment,
          build_id: testData.build_id || undefined,
          engagement: currentEngagementId
        };

        const response = await fetch('https://demo.defectdojo.org/api/v2/tests/?tags=crm_jira', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.getElementById('csrfToken').value
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          createdCount++;
        } else {
          const errorData = await response.json();
          showToast(`Failed to create test "${testData.title}": ${errorData.message || 'Unknown error'}`, 'error');
        }
      }

      if (createdCount > 0) {
        showToast(`${createdCount} test(s) created successfully`, 'success');
      } else if (createdCount === 0 && existingTitles.length >= testTemplates.length) {
        showToast('All tests already exist for this engagement', 'info');
      }
    } catch (error) {
      console.error('Error creating risk tests:', error);
      showToast('Error creating risk tests', 'error');
    } finally {
      loadingModal.hide();
    }
  }





// Add these variables at the top of the script section
let reportModal;
const reportTests = {};

// Add to DOMContentLoaded
reportModal = new bootstrap.Modal(document.getElementById('reportModal'), { 
  backdrop: 'static', // Prevent closing by clicking outside
  keyboard: false     // Prevent closing with ESC key
});


document.getElementById('reportEngagements').addEventListener('click', openReportModal);
document.getElementById('viewReport').addEventListener('click', viewReport);

// New functions
// Update the openReportModal function
async function openReportModal() {
    const engagementSelect = document.getElementById('reportEngagementSelect');
    engagementSelect.innerHTML = '<option value="">Select a Patch</option>';
    filteredEngagements.forEach(e => {
      const option = document.createElement('option');
      option.value = e.id;
      option.textContent = `${e.id} - ${e.name}`;
      engagementSelect.appendChild(option);
    });

    $('#reportEngagementSelect').select2({
      theme: 'bootstrap-5',
      width: '100%',
      dropdownParent: $('#reportModal'),
      placeholder: 'Select a Patch',
      allowClear: true
    });

    $('#reportEngagementSelect').val(null).trigger('change');
    reportTests.summary = [];
    reportTests.build = [];
    reportTests.risk = [];

    // Show the modal first, then clear tables once DOM is ready
    reportModal.show();
    // Use a small timeout to ensure modal DOM is fully rendered
    setTimeout(() => {
      clearReportTables();
    }, 0);

    $('#reportEngagementSelect').on('change', async function() {
      const engagementId = $(this).val();
      if (engagementId) {
        reportTests.summary = [];
        reportTests.build = [];
        reportTests.risk = [];
        await fetchReportData([engagementId]);
      } else {
        clearReportTables();
      }
    });
  }





// Update fetchReportData function to prevent duplicates
async function fetchReportData(engagementIds) {
  loadingModal.show();
  try {
    // Clear existing data completely
    reportTests.summary = [];
    reportTests.build = [];
    reportTests.risk = [];

    const engagementId = engagementIds[0]; // Since we're only allowing one engagement
    const response = await fetch(`https://demo.defectdojo.org/api/v2/tests/?tags=crm_jira&engagement=${engagementId}`);
    if (response.ok) {
      const data = await response.json();
      const tests = data.results;

      // Filter tests and ensure no duplicates by using Set for unique IDs
      const uniqueTests = Array.from(new Map(tests.map(t => [t.id, t])).values());
      
      reportTests.summary = uniqueTests.filter(t => t.tags.includes('reporting_patches'));
      reportTests.build = uniqueTests.filter(t => t.tags.includes('pci_jira'));
      reportTests.risk = uniqueTests.filter(t => t.tags.includes('risk_register'));

      await enrichJiraWithLeadNames([...reportTests.summary, ...reportTests.build, ...reportTests.risk]);
      renderReportTables(engagementIds);
    } else {
      showToast('Failed to fetch report data', 'error');
    }
  } catch (error) {
    console.error('Error fetching report data:', error);
    showToast('Error fetching report data', 'error');
  } finally {
    loadingModal.hide();
  }
}

// Update renderReportTables to use unique entries
function renderReportTables(engagementIds) {
  const selectedEngagements = filteredEngagements.filter(e => engagementIds.includes(e.id.toString()));
  
  // Summary Table (unchanged)
  const summaryBody = document.getElementById('summaryReportBody');
  summaryBody.innerHTML = selectedEngagements.map(e => `
    <tr>
      <td>${e.name}</td>
      <td>${e.lead_name}</td>
      <td>Functional: ${reportTests.build.filter(t => t.build_id === 'Functional' && t.engagement === e.id).length}, 
          Security: ${reportTests.build.filter(t => t.build_id === 'Security' && t.engagement === e.id).length}</td>
    </tr>
  `).join('');

  const contrastBody = document.getElementById('contrastReportBody');
  contrastBody.innerHTML = selectedEngagements.map(e => {
    const reportingTest = reportTests.summary.find(t => t.engagement === e.id) || {};
    return `
      <tr>
        <td>
          <select class="form-select" data-id="${reportingTest.id || ''}" data-field="commit_hash">
            <option value="Yes" ${reportingTest.commit_hash === 'Yes' ? 'selected' : ''}>Yes</option>
            <option value="No" ${reportingTest.commit_hash === 'No' ? 'selected' : ''}>No</option>
          </select>
        </td>
        <td>
          <textarea class="form-control" data-id="${reportingTest.id || ''}" data-field="description">${reportingTest.description || ''}</textarea>
        </td>
      </tr>
    `;
  }).join('');

  // Build Analysis Table
  const today = new Date().toISOString().slice(0, 10);
  const buildHeaderBody = document.getElementById('buildHeaderReportBody');
  buildHeaderBody.innerHTML = selectedEngagements.map(e => `
    <tr>
      <td>${e.name}</td>
      <td>${today}</td>
      <td>${reportTests.build.length}</td>  <!-- Use current length directly -->
    </tr>
  `).join('');

  const buildAnalysisBody = document.getElementById('buildAnalysisReportBody');
  // Remove duplicates by mapping to unique test IDs
  const uniqueBuildTests = Array.from(new Map(reportTests.build.map(t => [t.id, t])).values());
  buildAnalysisBody.innerHTML = uniqueBuildTests.map((t, index) => {
    const mscrMatch = t.description?.match(/manual secure code review: (na|done|not done)/i);
    const mstMatch = t.description?.match(/manual security testing: (na|done|not done)/i);
    return `
      <tr>
        <td>${index + 1}</td>
        <td>${usersCache[t.lead]?.name || 'Unassigned'}</td>
        <td>${t.title}</td>
        <td>${t.build_id || ''}</td>
        <td>${mscrMatch ? mscrMatch[1].toUpperCase() : 'NA'}</td>
        <td>${mstMatch ? mstMatch[1].toUpperCase() : 'NA'}</td>
        <td><textarea class="form-control" data-id="${t.id}" data-field="description">${t.description || ''}</textarea></td>
        <td>${t.branch_tag || ''}</td>
      </tr>
    `;
  }).join('');

  // Risk Register Table
  const riskBody = document.getElementById('riskRegisterReportBody');
  // Remove duplicates by mapping to unique test IDs
  const uniqueRiskTests = Array.from(new Map(reportTests.risk.map(t => [t.id, t])).values());
  riskBody.innerHTML = uniqueRiskTests.map((t, index) => {
    return `
      <tr>
        <td>${index + 1}</td>
        <td>${t.title}</td>
        <td>
          <select class="form-select" data-id="${t.id}" data-field="build_id">
            <option value="NA" ${t.build_id === 'NA' ? 'selected' : ''}>NA</option>
            <option value="Found" ${t.build_id === 'Found' ? 'selected' : ''}>Found</option>
            <option value="Not Found" ${t.build_id === 'Not Found' ? 'selected' : ''}>Not Found</option>
          </select>
        </td>
        <td><input type="text" class="form-control" data-id="${t.id}" data-field="commit_hash" value="${t.commit_hash || ''}"></td>
      </tr>
    `;
  }).join('');

  // Add event listeners for autosave (unchanged)
  document.querySelectorAll('#reportModal textarea, #reportModal select, #reportModal input').forEach(element => {
    element.addEventListener('change', debounce(async (e) => {
      const testId = e.target.getAttribute('data-id');
      const field = e.target.getAttribute('data-field');
      const value = e.target.value;
      if (testId) await saveJiraTest(testId, field, value);
    }, 500));
  });
}




function clearReportTables() {
    const summaryReportBody = document.getElementById('summaryReportBody');
    const contrastReportBody = document.getElementById('contrastReportBody');
    const buildHeaderReportBody = document.getElementById('buildHeaderReportBody');
    const buildAnalysisReportBody = document.getElementById('buildAnalysisReportBody');
    const riskRegisterReportBody = document.getElementById('riskRegisterReportBody');

    if (summaryReportBody) summaryReportBody.innerHTML = '';
    else console.error('summaryReportBody element not found');
    if (contrastReportBody) contrastReportBody.innerHTML = '';
    else console.error('contrastReportBody element not found');
    if (buildHeaderReportBody) buildHeaderReportBody.innerHTML = '';
    else console.error('buildHeaderReportBody element not found');
    if (buildAnalysisReportBody) buildAnalysisReportBody.innerHTML = '';
    else console.error('buildAnalysisReportBody element not found');
    if (riskRegisterReportBody) riskRegisterReportBody.innerHTML = '';
    else console.error('riskRegisterReportBody element not found');
  }

// Debounce function to prevent GUI flicker
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function viewReport() {
  const engagementIds = $('#reportEngagementSelect').val();
  if (!engagementIds || engagementIds.length === 0) {
    showToast('Please select at least one engagement', 'error');
    return;
  }

  const selectedEngagements = filteredEngagements.filter(e => engagementIds.includes(e.id.toString()));
  const reportHtml = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>${selectedEngagements[0].name} Report</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #343a40; color: white; }
        h2 { color: #343a40; }
        hr { margin: 20px 0; }
        @media print {
          .no-print { display: none; }
          @page { margin: 0; }
          body { margin: 1cm; }
        }
      </style>
    </head>
    <body>
      <h2>Patch Report</h2>
      <h3>Summary</h3>
      <table>
        <tr><th>Name</th><th>Prepared By</th><th>Total Changelogs</th></tr>
        ${selectedEngagements.map(e => `
          <tr>
            <td>${e.name}</td>
            <td>${e.lead_name}</td>
            <td>Functional: ${reportTests.build.filter(t => t.build_id === 'Functional' && t.engagement === e.id).length}, 
                Security: ${reportTests.build.filter(t => t.build_id === 'Security' && t.engagement === e.id).length}</td>
          </tr>
        `).join('')}
      </table>
      <table>
        <tr><th>Contrast Verification</th><th>Conclusion</th></tr>
        ${selectedEngagements.map(e => {
          const test = reportTests.summary.find(t => t.engagement === e.id) || {};
          return `
            <tr>
              <td>${test.commit_hash || 'No'}</td>
              <td>${test.description || ''}</td>
            </tr>
          `;
        }).join('')}
      </table>

      <h3>Build Analysis</h3>
      <table>
        <tr><th>Build</th><th>Date</th><th>Total Number of Jiras</th></tr>
        ${selectedEngagements.map(e => `
          <tr>
            <td>${e.name}</td>
            <td>${new Date().toISOString().slice(0, 10)}</td>
            <td>${reportTests.build.filter(t => t.engagement === e.id).length}</td>
          </tr>
        `).join('')}
      </table>
      <hr>
      <table>
        <tr>
          <th>Sr. No.</th>
          <th>Changelog Reviewer</th>
          <th>Issue Key</th>
          <th>Jira Type</th>
          <th>Manual Secure Code Review</th>
          <th>Manual Security Testing</th>
          <th>Remark</th>
          <th>Jira Status</th>
        </tr>
        ${reportTests.build.map((t, index) => {
          const mscrMatch = t.description?.match(/manual secure code review: (na|done|not done)/i);
          const mstMatch = t.description?.match(/manual security testing: (na|done|not done)/i);
          return `
            <tr>
              <td>${index + 1}</td>
              <td>${usersCache[t.lead]?.name || 'Unassigned'}</td>
              <td>${t.title}</td>
              <td>${t.build_id || ''}</td>
              <td>${mscrMatch ? mscrMatch[1].toUpperCase() : 'NA'}</td>
              <td>${mstMatch ? mstMatch[1].toUpperCase() : 'NA'}</td>
              <td>${t.description || ''}</td>
              <td>${t.branch_tag || ''}</td>
            </tr>
          `;
        }).join('')}
      </table>

      <h3>Risk Register</h3>
      <table>
        <tr><th>Sr. No.</th><th>Category</th><th>Status</th><th>Comment</th></tr>
        ${reportTests.risk.map((t, index) => `
          <tr>
            <td>${index + 1}</td>
            <td>${t.title}</td>
            <td>${t.build_id || 'NA'}</td>
            <td>${t.commit_hash || ''}</td>
          </tr>
        `).join('')}
      </table>

      <button class="no-print" onclick="window.print()">Print</button>
    </body>
    </html>
  `;

  const newWindow = window.open('', '_blank');
  newWindow.document.write(reportHtml);
  newWindow.document.close();
  newWindow.document.title = `${selectedEngagements[0].name}_Report`;
}

















document.getElementById("refreshTable").onclick = async () => {
  loadingModal.show();
  try {
    await fetchEngagements();
    applyFilters();
    showToast('Table refreshed successfully', 'success');
  } catch (error) {
    console.error('Error refreshing table:', error);
    showToast('Error refreshing table', 'error');
  } finally {
    loadingModal.hide();
  }
};








    const tableBody = document.getElementById("engagementTableBody");
    const closedTableBody = document.getElementById("closedEngagementTableBody");
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'), { backdrop: 'static' });
    const paginationStatus = document.getElementById("paginationStatus");
    const closedPaginationStatus = document.getElementById("closedPaginationStatus");

    // Initialize searchable dropdowns
    $(document).ready(function() {
      $('.searchable-select').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Search...',
        allowClear: true
      });
    });





async function fetchJiraData(engagementId) {
  try {
    const response = await fetch(`https://demo.defectdojo.org/api/v2/tests/?tags=crm_jira&engagement=${engagementId}`, {
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.getElementById('csrfToken').value
      }
    });
    if (response.ok) {
      const data = await response.json();
      const tests = data.results;
      let jiraData = { total: tests.length, security: 0, functional: 0, doable: 0, nonDoable: 0 };
      
      tests.forEach(test => {
        // Check commit_hash for Security/Functional
        if (test.commit_hash === 'Security') {
          jiraData.security++;
        } else {
          jiraData.functional++;
        }
        // Existing logic for Doable/Non Doable (unchanged)
        if (['Ready for Testing', 'Done', 'Ready for QA'].includes(test.build_id)) {
          jiraData.doable++;
        } else {
          jiraData.nonDoable++;
        }
      });
      
      return jiraData;
    }
    return { total: 0, security: 0, functional: 0, doable: 0, nonDoable: 0 };
  } catch (error) {
    console.error('Error fetching Jira data:', error);
    return { total: 0, security: 0, functional: 0, doable: 0, nonDoable: 0 };
  }
}






    async function fetchEngagements() {
      loadingModal.show();
      const urls = [
        'https://demo.defectdojo.org/api/v2/engagements/?tags=pci&status=Not%20Started&o=-created',
        'https://demo.defectdojo.org/api/v2/engagements/?tags=pci&status=In%20Progress&o=-created',
        'https://demo.defectdojo.org/api/v2/engagements/?tags=pci&status=On%20Hold&o=-created'
      ];

      const responses = await Promise.all(urls.map(url => fetch(url)));
      const results = await Promise.all(responses.map(res => res.json()));

      allEngagements = results.flatMap(res => res.results);
      await enrichWithLeadNames(allEngagements);
      
      populateFilterDropdowns();
      filteredEngagements = [...allEngagements];
      
      updateStatusCounts();
      renderTable();
      loadingModal.hide();
    }

    async function fetchClosedEngagements() {
      loadingModal.show();
      const urls = [
        'https://demo.defectdojo.org/api/v2/engagements/?tags=pci&status=Blocked',
        'https://demo.defectdojo.org/api/v2/engagements/?tags=pci&status=Completed',
        'https://demo.defectdojo.org/api/v2/engagements/?tags=pci&status=Cancelled'
      ];

      const responses = await Promise.all(urls.map(url => fetch(url)));
      const results = await Promise.all(responses.map(res => res.json()));

      closedEngagements = results.flatMap(res => res.results);
      await enrichWithLeadNames(closedEngagements);
      renderClosedTable();
      loadingModal.hide();
    }

    async function fetchCompletedSummary() {
      const startDate = document.getElementById('completedStartDate').value;
      const endDate = document.getElementById('completedEndDate').value;

      if (!startDate || !endDate) {
        showToast('Please select both start and end dates', 'error');
        return;
      }

      loadingModal.show();

      const startISO = `${startDate}T00:00:00Z`;
      const endISO = `${endDate}T23:59:59Z`;
      const url = `https://demo.defectdojo.org/api/v2/engagements/?tags=pci&status=Completed&active=false&updated__gte=${startISO}&updated__lte=${endISO}`;

      try {
        const response = await fetch(url);
        if (response.ok) {
          const data = await response.json();
          completedEngagements = data.results;
          await enrichWithLeadNames(completedEngagements);

          const summary = {
            total: completedEngagements.length,
            approved: completedEngagements.filter(e => e.commit_hash === 'Approved').length,
            approvedWithException: completedEngagements.filter(e => e.commit_hash === 'Approved with Exception').length,
            rejected: completedEngagements.filter(e => e.commit_hash === 'Rejected').length
          };

          document.getElementById('totalCompleted').textContent = summary.total;
          document.getElementById('approvedCount').textContent = summary.approved;
          document.getElementById('approvedWithExceptionCount').textContent = summary.approvedWithException;
          document.getElementById('rejectedCount').textContent = summary.rejected;
        } else {
          showToast('Failed to fetch completed summary', 'error');
        }
      } catch (error) {
        console.error('Error fetching completed summary:', error);
        showToast('Error fetching completed summary', 'error');
      } finally {
        loadingModal.hide();
      }
    }

    async function enrichWithLeadNames(engagements) {
      const leadIds = [...new Set(engagements.map(e => e.lead).filter(Boolean))];
      const leadMap = {};

      await Promise.all(leadIds.map(async id => {
        const res = await fetch(`https://demo.defectdojo.org/api/v2/users/${id}/`);
        if (res.ok) {
          const data = await res.json();
          leadMap[id] = `${data.first_name} ${data.last_name}`;
        }
      }));

      engagements.forEach(e => {
        e.lead_name = leadMap[e.lead] || 'Unassigned';
      });
    }
    
    async function fetchAllProducts() {
      if (Object.keys(productsCache).length > 0) return productsCache;
      
      try {
        const response = await fetch('https://demo.defectdojo.org/api/v2/products/');
        if (response.ok) {
          const data = await response.json();
          data.results.forEach(product => {
            productsCache[product.id] = {
              id: product.id,
              name: product.name
            };
          });
        }
      } catch (error) {
        console.error('Error fetching products:', error);
      }
      
      return productsCache;
    }

    
	async function fetchAllUsers() {
    if (Object.keys(usersCache).length > 0) return;
    try {
      const response = await fetch('https://demo.defectdojo.org/api/v2/users/', {
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.getElementById('csrfToken').value
        }
      });
      if (response.ok) {
        const data = await response.json();
        data.results.forEach(user => {
          usersCache[String(user.id)] = { id: String(user.id), name: `${user.first_name} ${user.last_name}`.trim() || user.username };
        });
      }
    } catch (error) {
      console.error('Error fetching users:', error);
    }
  }
	
	
	
    function updateStatusCounts() {
      const notStartedCount = allEngagements.filter(e => e.status === 'Not Started').length;
      const inProgressCount = allEngagements.filter(e => e.status === 'In Progress').length;
      const onHoldCount = allEngagements.filter(e => e.status === 'On Hold').length;

      document.getElementById('notStartedCount').textContent = notStartedCount;
      document.getElementById('inProgressCount').textContent = inProgressCount;
      document.getElementById('onHoldCount').textContent = onHoldCount;
    }

    function populateFilterDropdowns() {
      $('#assignedToFilter, #createdByFilter').select2('destroy');
      
      const assignedToSet = new Set(allEngagements.map(e => e.lead_name).filter(Boolean).sort());
      const assignedToFilter = document.getElementById('assignedToFilter');
      assignedToFilter.innerHTML = '<option value="">All</option>';
      assignedToSet.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        assignedToFilter.appendChild(option);
      });
      
      const createdBySet = new Set(allEngagements.map(e => e.reason).filter(Boolean).sort());
      const createdByFilter = document.getElementById('createdByFilter');
      createdByFilter.innerHTML = '<option value="">All</option>';
      createdBySet.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        createdByFilter.appendChild(option);
      });
      
      const statusAnalystSet = new Set(allEngagements.map(e => e.status).filter(Boolean).sort());
      const statusAnalystFilter = document.getElementById('statusAnalystFilter');
      statusAnalystFilter.innerHTML = '<option value="">All</option>';
      statusAnalystSet.forEach(status => {
        const option = document.createElement('option');
        option.value = status;
        option.textContent = status;
        statusAnalystFilter.appendChild(option);
      });
      
      const statusMentorSet = new Set(allEngagements.map(e => e.branch_tag).filter(Boolean).sort());
      const statusMentorFilter = document.getElementById('statusMentorFilter');
      statusMentorFilter.innerHTML = '<option value="">All</option>';
      statusMentorSet.forEach(status => {
        const option = document.createElement('option');
        option.value = status;
        option.textContent = status;
        statusMentorFilter.appendChild(option);
      });
      
      const statusLeadSet = new Set(allEngagements.map(e => e.commit_hash).filter(Boolean).sort());
      const statusLeadFilter = document.getElementById('statusLeadFilter');
      statusLeadFilter.innerHTML = '<option value="">All</option>';
      statusLeadSet.forEach(status => {
        const option = document.createElement('option');
        option.value = status;
        option.textContent = status;
        statusLeadFilter.appendChild(option);
      });
      
      $('.searchable-select').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Search...',
        allowClear: true
      });
    }

    function applyFilters() {
      const idValue = document.getElementById('idFilter').value;
      const createdValue = document.getElementById('createdFilter').value;
      const agingValue = document.getElementById('agingFilter').value;
      const agingCondition = document.getElementById('agingCondition').value;
      const createdByValue = $('#createdByFilter').val();
      const statusAnalystValue = document.getElementById('statusAnalystFilter').value;
      const statusMentorValue = document.getElementById('statusMentorFilter').value;
      const statusLeadValue = document.getElementById('statusLeadFilter').value;
      const nameValue = document.getElementById('nameFilter').value.toLowerCase();
      const assignedToValue = $('#assignedToFilter').val();
      const appSecETAValue = document.getElementById('appSecETAFilter').value;
      const rmETAValue = document.getElementById('rmETAFilter').value;
      const irValue = document.getElementById('irFilter').value.toLowerCase();
      
      const today = new Date();
      
      filteredEngagements = allEngagements.filter(engagement => {
        if (idValue && engagement.id.toString() !== idValue) return false;
        if (createdValue && engagement.created.slice(0, 10) !== createdValue) return false;
        if (agingValue) {
          const created = new Date(engagement.created);
          const aging = Math.floor((today - created) / (1000 * 60 * 60 * 24));
          if (agingCondition === 'lt' && !(aging < parseInt(agingValue))) return false;
          if (agingCondition === 'gt' && !(aging > parseInt(agingValue))) return false;
          if (agingCondition === 'eq' && !(aging === parseInt(agingValue))) return false;
        }
        if (createdByValue && engagement.reason !== createdByValue) return false;
        if (statusAnalystValue && engagement.status !== statusAnalystValue) return false;
        if (statusMentorValue && engagement.branch_tag !== statusMentorValue) return false;
        if (statusLeadValue && engagement.commit_hash !== statusLeadValue) return false;
        if (nameValue && !engagement.name.toLowerCase().includes(nameValue)) return false;
        if (assignedToValue && engagement.lead_name !== assignedToValue) return false;
        if (appSecETAValue && engagement.target_start && engagement.target_start.slice(0, 10) !== appSecETAValue) return false;
        if (rmETAValue && engagement.target_end && engagement.target_end.slice(0, 10) !== rmETAValue) return false;
        if (irValue && (!engagement.version || !engagement.version.toLowerCase().includes(irValue))) return false;
        return true;
      });
      
      currentPage = 1;
      renderTable();
    }
    
    function resetFilters() {
      document.getElementById('idFilter').value = '';
      document.getElementById('createdFilter').value = '';
      document.getElementById('agingFilter').value = '';
      document.getElementById('agingCondition').value = 'lt';
      $('#createdByFilter').val(null).trigger('change');
      document.getElementById('statusAnalystFilter').value = '';
      document.getElementById('statusMentorFilter').value = '';
      document.getElementById('statusLeadFilter').value = '';
      document.getElementById('nameFilter').value = '';
      $('#assignedToFilter').val(null).trigger('change');
      document.getElementById('appSecETAFilter').value = '';
      document.getElementById('rmETAFilter').value = '';
      document.getElementById('irFilter').value = '';
      
      filteredEngagements = [...allEngagements];
      currentPage = 1;
      renderTable();
    }

    function getHighlightClass(dateStr) {
      if (!dateStr) return '';
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const tomorrow = new Date(today);
      tomorrow.setDate(today.getDate() + 1);
      const isFriday = today.getDay() === 5;
      const monday = new Date(today);
      if (isFriday) monday.setDate(today.getDate() + 3);
      else monday.setDate(today.getDate() + (8 - today.getDay()) % 7);

      const cellDate = new Date(dateStr);
      cellDate.setHours(0, 0, 0, 0);

      if (cellDate.getTime() === today.getTime()) return 'highlight-today';
      if (cellDate.getTime() === tomorrow.getTime() || (isFriday && cellDate.getTime() === monday.getTime())) return 'highlight-upcoming';
      return '';
    }


async function renderTable() {
  const start = (currentPage - 1) * pageSize;
  const pagedData = filteredEngagements.slice(start, start + pageSize);
  const today = new Date();
  const totalPages = Math.ceil(filteredEngagements.length / pageSize);

  // Fetch Jira data for all engagements in parallel
  const jiraDataPromises = pagedData.map(e => fetchJiraData(e.id));
  const jiraDataArray = await Promise.all(jiraDataPromises);

  tableBody.innerHTML = pagedData.map((e, index) => {
    const created = new Date(e.created);
    const aging = Math.floor((today - created) / (1000 * 60 * 60 * 24));
    const appSecETA = e.target_start ? e.target_start.slice(0, 10) : '';
    const appSecClass = getHighlightClass(appSecETA);

    return `
      <tr data-id="${e.id}">
        <td>${e.id}</td>
        <td>${e.created.slice(0, 10)}</td>
        <td>${aging} days</td>
        <td>${e.name}</td>
        <td>${jiraDataArray[index].total}</td>
        <td>${jiraDataArray[index].security}</td>
        <td>${jiraDataArray[index].functional}</td>
        <td>${jiraDataArray[index].doable}</td>
        <td>${jiraDataArray[index].nonDoable}</td>
        <td>${e.lead_name}</td>
        <td class="${appSecClass}">
          <input type="date" class="form-control appsec-eta-input" value="${appSecETA}" data-id="${e.id}">
        </td>
        <td>
          <select class="form-select status-analyst-select" data-id="${e.id}">
            <option value="Not Started" ${e.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
            <option value="In Progress" ${e.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
            <option value="On Hold" ${e.status === 'On Hold' ? 'selected' : ''}>On Hold</option>
            <option value="Completed" ${e.status === 'Completed' ? 'selected' : ''}>Completed</option>
          </select>
        </td>
        <td>
          <select class="form-select status-mentor-select" data-id="${e.id}">
            <option value="Not Started" ${e.branch_tag === 'Not Started' ? 'selected' : ''}>Not Started</option>
            <option value="In Progress" ${e.branch_tag === 'In Progress' ? 'selected' : ''}>In Progress</option>
            <option value="On Hold" ${e.branch_tag === 'On Hold' ? 'selected' : ''}>On Hold</option>
            <option value="Completed" ${e.branch_tag === 'Completed' ? 'selected' : ''}>Completed</option>
          </select>
        </td>
        <td>
          <select class="form-select status-lead-select" data-id="${e.id}">
            <option value="Not Started" ${e.commit_hash === 'Not Started' ? 'selected' : ''}>Not Started</option>  
            <option value="Approved" ${e.commit_hash === 'Approved' ? 'selected' : ''}>Approved</option>
            <option value="Approved with Exception" ${e.commit_hash === 'Approved with Exception' ? 'selected' : ''}>Approved with Exception</option>
            <option value="Rejected" ${e.commit_hash === 'Rejected' ? 'selected' : ''}>Rejected</option>
          </select>
        </td>
        <td>
          <input type="number" class="form-control ir-input" value="${e.version || ''}" data-id="${e.id}">
        </td>
        <td>
          <textarea class="form-control description-textarea" data-id="${e.id}" rows="2">${e.description || ''}</textarea>
        </td>
        <td>
          <button class="btn btn-sm btn-primary save-btn" data-id="${e.id}" title="Save"><i class="bi bi-save"></i></button>
          <button class="btn btn-sm btn-success edit-btn" data-id="${e.id}" title="Edit"><i class="bi bi-pencil-square"></i></button>
          <button class="btn btn-sm btn-danger close-btn" data-id="${e.id}" title="Close"><i class="bi bi-x-circle"></i></button>
          <button class="btn btn-sm btn-info jira-btn" data-id="${e.id}" title="Jira"><i class="bi bi-ticket-detailed"></i></button>
        </td>
      </tr>
    `;
  }).join('');

  paginationStatus.textContent = `Page ${currentPage} of ${totalPages} (${filteredEngagements.length} results)`;
  
  document.getElementById("prevPage").disabled = currentPage === 1;
  document.getElementById("firstPage").disabled = currentPage === 1;
  document.getElementById("nextPage").disabled = currentPage === totalPages;
  document.getElementById("lastPage").disabled = currentPage === totalPages;
  
  // Event listeners for save buttons
document.querySelectorAll('.save-btn').forEach(button => {
  button.addEventListener('click', async () => {
    const engagementId = parseInt(button.getAttribute('data-id'));
    const row = button.closest('tr');
    const engagement = allEngagements.find(e => e.id === engagementId);
    if (!engagement) return;

    const formData = {
      id: engagementId,
      name: engagement.name, // Preserve existing name
      target_start: row.querySelector('.appsec-eta-input').value || null,
      target_end: engagement.target_end || new Date().toISOString().slice(0, 10), // Use existing or default to today
      product: engagement.product || 1, // Use existing product or fallback to a default ID (adjust as needed)
      status: row.querySelector('.status-analyst-select').value,
      branch_tag: row.querySelector('.status-mentor-select').value,
      commit_hash: row.querySelector('.status-lead-select').value,
      version: row.querySelector('.ir-input').value,
      description: row.querySelector('.description-textarea').value
    };

    loadingModal.show();
    try {
      const response = await fetch(`https://demo.defectdojo.org/api/v2/engagements/${engagementId}/`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.getElementById('csrfToken').value
        },
        body: JSON.stringify(formData)
      });

      if (response.ok) {
        const updatedEngagement = await response.json();
        const index = allEngagements.findIndex(e => e.id === engagementId);
        if (index !== -1) {
          allEngagements[index] = { ...allEngagements[index], ...updatedEngagement };
          const filteredIndex = filteredEngagements.findIndex(e => e.id === engagementId);
          if (filteredIndex !== -1) {
            filteredEngagements[filteredIndex] = { ...filteredEngagements[filteredIndex], ...updatedEngagement };
          }
          updateStatusCounts();
          renderTable();
        }
        showToast('Engagement updated successfully', 'success');
      } else {
        const errorData = await response.json();
        showToast('Failed to update engagement: ' + JSON.stringify(errorData), 'error');
      }
    } catch (error) {
      console.error('Error updating engagement:', error);
      showToast('Error updating engagement', 'error');
    } finally {
      loadingModal.hide();
    }
  });
});

  document.querySelectorAll('.edit-btn').forEach(button => {
    button.addEventListener('click', () => {
      const engagementId = parseInt(button.getAttribute('data-id'));
      openEditModal(engagementId);
    });
  });

  document.querySelectorAll('.jira-btn').forEach(button => {
    button.addEventListener('click', () => {
      const engagementId = parseInt(button.getAttribute('data-id'));
      openAddJirasModal(engagementId);
    });
  });

  document.querySelectorAll('.close-btn').forEach(button => {
    button.addEventListener('click', () => {
      const engagementId = parseInt(button.getAttribute('data-id'));
      confirmCloseEngagement(engagementId);
    });
  });
}

async function openAddJirasModal(engagementId) {
  const engagement = allEngagements.find(e => e.id === engagementId);
  if (!engagement) return;

  document.getElementById('jiraEngagementId').value = engagementId;
  document.getElementById('jiraTitle').value = '';
  document.getElementById('jiraFileInput').value = '';
  document.getElementById('jiraKeysTextarea').value = '';
  document.getElementById('dropZone').style.backgroundColor = '#f8f9fa';
  
  addJirasModal.show();
}



function handleCloseJirasModal() {
  addJirasModal.hide();
}

function handleJirasXClose(e) {
  e.preventDefault();
  addJirasModal.hide();
}

async function saveJiras() {
  const engagementId = document.getElementById('jiraEngagementId').value;
  const engagement = allEngagements.find(e => e.id === parseInt(engagementId));
  if (!engagement) return;

  loadingModal.show();
  const today = new Date().toISOString().slice(0, 10);
  const baseTestData = {
    title: '',
    tags: ['pci_jira'],
    test_type_name: 'Qualys Scan',
    target_start: today,
    target_end: today,
    lead: engagement.lead || null,
    test_type: 21,
    environment: 3,
    commit_hash: 'Not Started'
  };

  try {
    // 1. Single Title Entry
    const title = document.getElementById('jiraTitle').value.trim();
    if (title) {
      await createTest(engagementId, { ...baseTestData, title });
    }

    // 2. Drag and Drop Files
    const files = document.getElementById('jiraFileInput').files;
    if (files.length > 0) {
      const jiraKeys = await extractJiraKeysFromFiles(files);
      for (const key of jiraKeys) {
        await createTest(engagementId, { ...baseTestData, title: key });
      }
    }

    // 3. Comma-Separated Values
    const textareaValue = document.getElementById('jiraKeysTextarea').value.trim();
    if (textareaValue) {
      const jiraKeys = textareaValue.split(',').map(key => key.trim()).filter(key => key);
      for (const key of jiraKeys) {
        await createTest(engagementId, { ...baseTestData, title: key });
      }
    }

    if (!title && files.length === 0 && !textareaValue) {
      showToast('Please provide at least one Jira entry (title, file, or textarea)', 'error');
    } else {
      addJirasModal.hide();
      showToast('Jira tests created successfully', 'success');
    }
  } catch (error) {
    console.error('Error creating Jira tests:', error);
    showToast('Error creating Jira tests', 'error');
  } finally {
    loadingModal.hide();
  }
}

async function createTest(engagementId, testData) {
  const existingTitles = await fetchExistingTests(engagementId);
  if (existingTitles.includes(testData.title)) {
    console.log(`Test with title "${testData.title}" already exists for engagement ${engagementId}. Skipping creation.`);
    return;
  }

  const payload = {
    title: testData.title,
    target_start: testData.target_start,
    target_end: testData.target_end,
    engagement: engagementId,
    lead: testData.lead,
    test_type: testData.test_type,
    environment: testData.environment,
    tags: testData.tags,
    test_type_name: testData.test_type_name,
    commit_hash: testData.commit_hash
  };

  const response = await fetch('https://demo.defectdojo.org/api/v2/tests/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.getElementById('csrfToken').value
    },
    body: JSON.stringify(payload)
  });

  if (!response.ok) {
    const errorData = await response.json();
    throw new Error(`Failed to create test: ${errorData.message || 'Unknown error'}`);
  }
}

async function handleFiles(files) {
  const dropZone = document.getElementById('dropZone');
  const fileNames = Array.from(files).map(file => file.name).join(', ');
  dropZone.innerHTML = `Files: ${fileNames} <input type="file" id="jiraFileInput" accept=".txt,.csv,.xlsx,.xls" multiple hidden>`;
  dropZone.style.backgroundColor = '#f8f9fa';
}





async function fetchExistingTests(engagementId) {
  const response = await fetch(`https://demo.defectdojo.org/api/v2/tests/?tags=crm_jira&engagement=${engagementId}`, {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.getElementById('csrfToken').value
    }
  });
  if (response.ok) {
    const data = await response.json();
    return data.results.map(test => test.title);
  }
  return [];
}




async function extractJiraKeysFromFiles(files) {
  const jiraKeys = [];
  
  for (const file of files) {
    const fileType = file.name.split('.').pop().toLowerCase();
    
    if (fileType === 'txt') {
      const text = await file.text();
      const lines = text.split('\n').map(line => line.trim()).filter(line => line);
      jiraKeys.push(...lines);
    } else if (fileType === 'csv') {
      const text = await file.text();
      const rows = text.split('\n').map(row => row.split(',')[0].trim()).filter(key => key);
      if (rows.length > 0 && rows[0].toLowerCase() !== 'issue key') {
        jiraKeys.push(...rows);
      } else {
        jiraKeys.push(...rows.slice(1));
      }
    } else if (fileType === 'xlsx' || fileType === 'xls') {
      const arrayBuffer = await file.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      const header = rows[0].map(h => h.toString().toLowerCase());
      const issueKeyIndex = header.indexOf('issue key');
      if (issueKeyIndex !== -1) {
        jiraKeys.push(...rows.slice(1).map(row => row[issueKeyIndex]?.toString().trim()).filter(key => key));
      } else {
        jiraKeys.push(...rows.map(row => row[0]?.toString().trim()).filter(key => key));
      }
    }
  }
  
  return jiraKeys.filter(key => key.match(/^[A-Z]+-\d+$/)); // Basic Jira key validation
}

// Include XLSX library for Excel file parsing
const script = document.createElement('script');
script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
document.head.appendChild(script);
















    function renderClosedTable() {
      const start = (closedCurrentPage - 1) * closedPageSize;
      const pagedData = closedEngagements.slice(start, start + closedPageSize);

      document.getElementById('totalClosedCount').textContent = closedEngagements.length;

      closedTableBody.innerHTML = pagedData.map(e => `
        <tr>
          <td>${e.id}</td>
          <td>${e.name}</td>
          <td>${e.lead_name}</td>
          <td>${e.reason || ''}</td>
          <td>${e.status}</td>
          <td>
            <button class="btn btn-sm btn-primary reopen-btn" data-id="${e.id}" title="Reopen"><i class="bi bi-arrow-clockwise"></i></button>
          </td>
        </tr>
      `).join('');

      const totalPages = Math.ceil(closedEngagements.length / closedPageSize);
      closedPaginationStatus.textContent = `Page ${closedCurrentPage} of ${totalPages} (${closedEngagements.length} results)`;
      
      document.getElementById("closedPrevPage").disabled = closedCurrentPage === 1;
      document.getElementById("closedFirstPage").disabled = closedCurrentPage === 1;
      document.getElementById("closedNextPage").disabled = closedCurrentPage === totalPages;
      document.getElementById("closedLastPage").disabled = closedCurrentPage === totalPages;

      document.querySelectorAll('.reopen-btn').forEach(button => {
        button.addEventListener('click', () => {
          const engagementId = parseInt(button.getAttribute('data-id'));
          reopenEngagement(engagementId);
        });
      });
    }

    document.getElementById("firstPage").onclick = () => { currentPage = 1; renderTable(); };
    document.getElementById("prevPage").onclick = () => { if (currentPage > 1) currentPage--; renderTable(); };
    document.getElementById("nextPage").onclick = () => {
      const totalPages = Math.ceil(filteredEngagements.length / pageSize);
      if (currentPage < totalPages) currentPage++; renderTable();
    };
    document.getElementById("lastPage").onclick = () => {
      currentPage = Math.ceil(filteredEngagements.length / pageSize); renderTable();
    };
    
    document.getElementById("closedFirstPage").onclick = () => { closedCurrentPage = 1; renderClosedTable(); };
    document.getElementById("closedPrevPage").onclick = () => { if (closedCurrentPage > 1) closedCurrentPage--; renderClosedTable(); };
    document.getElementById("closedNextPage").onclick = () => {
      const totalPages = Math.ceil(closedEngagements.length / closedPageSize);
      if (closedCurrentPage < totalPages) closedCurrentPage++; renderClosedTable();
    };
    document.getElementById("closedLastPage").onclick = () => {
      closedCurrentPage = Math.ceil(closedEngagements.length / closedPageSize); renderClosedTable();
    };
    
    document.getElementById("applyFilters").onclick = applyFilters;
    document.getElementById("resetFilters").onclick = resetFilters;

    let currentEditingEngagement = null;
    let editModalChanged = false;
    let editEngagementModal;
    let confirmCloseModal;
    let summaryModal;
    let newEngagementModal;
    let confirmCloseEngagementModal;
    let viewClosedModal;
    let completedSummaryModal;

    // Replace the entire JavaScript section starting from line 1920 with this corrected version:

document.addEventListener('DOMContentLoaded', function() {

  addJirasModal = new bootstrap.Modal(document.getElementById('addJirasModal'), { backdrop: 'static', keyboard: false });
  document.getElementById('closeJirasModal').addEventListener('click', handleCloseJirasModal);
  document.getElementById('jirasModalCloseX').addEventListener('click', handleJirasXClose);
  document.getElementById('saveJiras').addEventListener('click', saveJiras);
  
  viewJirasModal = new bootstrap.Modal(document.getElementById('viewJirasModal'));
  document.getElementById('viewJiras').addEventListener('click', openViewJirasModal);
  
  // Drag and drop setup
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('jiraFileInput');
  
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.style.backgroundColor = '#e9ecef';
  });
  
  dropZone.addEventListener('dragleave', () => {
    dropZone.style.backgroundColor = '#f8f9fa';
  });
  
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.style.backgroundColor = '#f8f9fa';
    fileInput.files = e.dataTransfer.files;
    handleFiles(fileInput.files);
  });
  
  dropZone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', () => handleFiles(fileInput.files));
  
  editEngagementModal = new bootstrap.Modal(document.getElementById('editEngagementModal'), { backdrop: 'static', keyboard: false });
  confirmCloseModal = new bootstrap.Modal(document.getElementById('confirmCloseModal'));
  summaryModal = new bootstrap.Modal(document.getElementById('summaryModal'));
  newEngagementModal = new bootstrap.Modal(document.getElementById('newEngagementModal'), { backdrop: 'static', keyboard: false });
  confirmCloseEngagementModal = new bootstrap.Modal(document.getElementById('confirmCloseEngagementModal'));
  viewClosedModal = new bootstrap.Modal(document.getElementById('viewClosedModal'));
  completedSummaryModal = new bootstrap.Modal(document.getElementById('completedSummaryModal'));
  
  document.getElementById('closeEditModal').addEventListener('click', handleCloseEditModal);
  document.getElementById('modalCloseX').addEventListener('click', handleXClose);
  document.getElementById('confirmCloseBtn').addEventListener('click', confirmCloseEditModal);
  document.getElementById('confirmNoBtn').addEventListener('click', () => confirmCloseModal.hide());
  document.getElementById('saveEngagement').addEventListener('click', saveEngagementChanges);
  document.getElementById('viewSummary').addEventListener('click', openSummaryModal);
  document.getElementById('completedSummary').addEventListener('click', openCompletedSummaryModal);
  document.getElementById('viewClosed').addEventListener('click', openClosedModal);
  document.getElementById('newEngagement').addEventListener('click', openNewEngagementModal);
  document.getElementById('closeNewModal').addEventListener('click', handleCloseNewModal);
  document.getElementById('newModalCloseX').addEventListener('click', handleNewXClose);
  document.getElementById('saveNewEngagement').addEventListener('click', saveNewEngagement);
  document.getElementById('confirmCloseEngagementBtn').addEventListener('click', closeEngagement);
  document.getElementById('fetchCompletedSummary').addEventListener('click', fetchCompletedSummary);
  
  const editFormInputs = document.querySelectorAll('#editEngagementForm input, #editEngagementForm select, #editEngagementForm textarea');
  editFormInputs.forEach(element => {
    element.addEventListener('change', () => {
      editModalChanged = true;
    });
    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
      element.addEventListener('input', () => {
        editModalChanged = true;
      });
    }
  });
  
  fetchCSRFToken();
});

async function fetchCSRFToken() {
  try {
    const response = await fetch('https://demo.defectdojo.org/api/key-v2');
    if (response.ok) {
      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const csrfToken = doc.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
      if (csrfToken) {
        document.getElementById('csrfToken').value = csrfToken;
        document.getElementById('newCsrfToken').value = csrfToken;
      } else {
        console.error('CSRF token not found in response');
      }
    } else {
      console.error('Failed to fetch CSRF token');
    }
  } catch (error) {
    console.error('Error fetching CSRF token:', error);
  }
}

async function openViewJirasModal() {
  await populateEngagementSelect();
  await populateAssignedToFilter();
  jiraTests = [];
  filteredJiraTests = [];
  jiraCurrentPage = 1;
  document.getElementById('jiraTitleSearch').value = '';
  document.getElementById('jiraTypeFilter').value = '';
  document.getElementById('analysisStatusFilter').value = '';
  document.getElementById('jiraStatusFilter').value = '';
  $('#assignedToFilterJira').val(null).trigger('change');
  document.getElementById('jiraTableBody').innerHTML = '';
  viewJirasModal.show();
}

async function populateEngagementSelect() {
  const engagementSelect = document.getElementById('engagementSelect');
  engagementSelect.innerHTML = '<option value="">Select a Patch</option>';
  filteredEngagements.forEach(e => {
    const option = document.createElement('option');
    option.value = e.id;
    option.textContent = `${e.id} - ${e.name}`;
    engagementSelect.appendChild(option);
  });
  
  $('#engagementSelect').select2({
    theme: 'bootstrap-5',
    width: '100%',
    dropdownParent: $('#viewJirasModal'),
    placeholder: 'Select a Patch',
    allowClear: true
  });

  $('#engagementSelect').on('change', async function() {
    const engagementId = $(this).val();
    if (engagementId) {
      await fetchJiraTests(engagementId);
      applyJiraFilters();
    } else {
      jiraTests = [];
      filteredJiraTests = [];
      renderJiraTable();
    }
  });
}

async function populateAssignedToFilter() {
  const assignedToFilter = document.getElementById('assignedToFilterJira');
  assignedToFilter.innerHTML = '<option value="">All Assigned To</option>';
  await fetchAllUsers();
  Object.values(usersCache).forEach(user => {
    const option = document.createElement('option');
    option.value = user.id;
    option.textContent = user.name;
    assignedToFilter.appendChild(option);
  });

  $('#assignedToFilterJira').select2({
    theme: 'bootstrap-5',
    width: '100%',
    dropdownParent: $('#viewJirasModal'),
    placeholder: 'All Assigned To',
    allowClear: true
  });
}




async function fetchJiraTests(engagementId) {
    loadingModal.show();
    try {
      const response = await fetch(`https://demo.defectdojo.org/api/v2/tests/?tags=crm_jira&engagement=${engagementId}&tags=crm_jira`, {
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.getElementById('csrfToken').value
        }
      });
      if (response.ok) {
        const data = await response.json();
        jiraTests = data.results;
        await enrichJiraWithLeadNames(jiraTests); // Enrich with lead names
        filteredJiraTests = [...jiraTests];
        renderJiraTable();
      } else {
        showToast('Failed to fetch Jira tests', 'error');
      }
    } catch (error) {
      console.error('Error fetching Jira tests:', error);
      showToast('Error fetching Jira tests', 'error');
    } finally {
      loadingModal.hide();
    }
  }





function applyJiraFilters() {
  const titleSearch = document.getElementById('jiraTitleSearch').value.toLowerCase();
  const typeFilter = document.getElementById('jiraTypeFilter').value;
  const statusFilter = document.getElementById('analysisStatusFilter').value;
  const jiraStatusFilter = document.getElementById('jiraStatusFilter').value;
  const assignedToFilter = $('#assignedToFilterJira').val();

  filteredJiraTests = jiraTests.filter(test => {
    if (titleSearch && !test.title.toLowerCase().includes(titleSearch)) return false;
    if (typeFilter && test.build_id !== typeFilter) return false;
    if (statusFilter && test.commit_hash !== statusFilter) return false;
    if (jiraStatusFilter && test.branch_tag !== jiraStatusFilter) return false;
    if (assignedToFilter && test.lead !== assignedToFilter) return false;
    return true;
  });

  jiraCurrentPage = 1;
  renderJiraTable();
}

async function saveJiraTest(testId, field, value) {
    try {
      const payload = {};
      if (field === 'lead') {
        payload[field] = value ? parseInt(value) : null; // Convert to integer or null for API
      } else {
        payload[field] = value;
      }
      const response = await fetch(`https://demo.defectdojo.org/api/v2/tests/${testId}/`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.getElementById('csrfToken').value
        },
        body: JSON.stringify(payload)
      });
      if (response.ok) {
        const updatedTest = await response.json();
        const index = jiraTests.findIndex(t => t.id === testId);
        if (index !== -1) {
          jiraTests[index] = { ...jiraTests[index], ...updatedTest };
          jiraTests[index].lead = updatedTest.lead ? String(updatedTest.lead) : ''; // Ensure string for UI
          jiraTests[index].lead_name = updatedTest.lead && usersCache[updatedTest.lead] ? usersCache[updatedTest.lead].name : 'Unassigned';
          filteredJiraTests = [...jiraTests];
          applyJiraFilters(); // Re-render with updated data
          showToast('Jira test updated successfully', 'success');
        }
      } else {
        const errorData = await response.json();
        showToast(`Failed to update Jira test: ${errorData.message || 'Unknown error'}`, 'error');
      }
    } catch (error) {
      console.error('Error saving Jira test:', error);
      showToast('Error saving Jira test', 'error');
    }
  }  



function renderJiraTable() {
  const start = (jiraCurrentPage - 1) * jiraPageSize;
  const pagedData = filteredJiraTests.slice(start, start + jiraPageSize);
  const totalPages = Math.ceil(filteredJiraTests.length / jiraPageSize);

  const jiraTableBody = document.getElementById('jiraTableBody');
  jiraTableBody.innerHTML = pagedData.map(t => `
    <tr>
      <td>${t.id}</td>
      <td>${t.title}</td>
      <td><textarea class="form-control" data-id="${t.id}" data-field="description">${t.description || ''}</textarea></td>
      <td>
        <select class="form-select" data-id="${t.id}" data-field="build_id">
          <option value="Ready for Testing" ${t.build_id === 'Ready for Testing' ? 'selected' : ''}>Ready for Testing (Doable)</option>
          <option value="Done" ${t.build_id === 'Done' ? 'selected' : ''}>Done (Doable)</option>
          <option value="Ready for QA" ${t.build_id === 'Ready for QA' ? 'selected' : ''}>Ready for QA (Doable)</option>
          <option value="Other" ${t.build_id && !['Ready for Testing', 'Done', 'Ready for QA'].includes(t.build_id) ? 'selected' : ''}>Other (Non Doable)</option>
        </select>
      </td>
      <td>
        <select class="form-select" data-id="${t.id}" data-field="commit_hash">
          <option value="Security" ${t.commit_hash === 'Security' ? 'selected' : ''}>Security</option>
          <option value="Functional" ${t.commit_hash !== 'Security' ? 'selected' : ''}>Functional</option>
        </select>
      </td>
      <td><input type="text" class="form-control" data-id="${t.id}" data-field="branch_tag" value="${t.branch_tag || ''}"></td>
      <td>
        <select class="form-select searchable-select" data-id="${t.id}" data-field="lead">
          <option value="" ${!t.lead ? 'selected' : ''}>Unassigned</option>
          ${Object.values(usersCache).map(user => `
            <option value="${user.id}" ${t.lead === String(user.id) ? 'selected' : ''}>${user.name}</option>
          `).join('')}
        </select>
      </td>
      <td>
        <button class="btn btn-sm btn-primary save-jira-btn" data-id="${t.id}" title="Save"><i class="bi bi-save"></i></button>
      </td>
    </tr>
  `).join('');

  document.getElementById('jiraPaginationStatus').textContent = `Page ${jiraCurrentPage} of ${totalPages} (${filteredJiraTests.length} results)`;
  document.getElementById("jiraPrevPage").disabled = jiraCurrentPage === 1;
  document.getElementById("jiraFirstPage").disabled = jiraCurrentPage === 1;
  document.getElementById("jiraNextPage").disabled = jiraCurrentPage === totalPages;
  document.getElementById("jiraLastPage").disabled = jiraCurrentPage === totalPages;

  // Destroy existing select2 instances
  $('#jiraTableBody .searchable-select').each(function() {
    if ($(this).hasClass('select2-hidden-accessible')) {
      $(this).select2('destroy');
    }
  });

  // Initialize select2
  $('#jiraTableBody .searchable-select').select2({
    theme: 'bootstrap-5',
    width: '100%',
    dropdownParent: $('#viewJirasModal'),
    placeholder: 'Unassigned',
    allowClear: true
  });

  // Add event listeners for Save buttons
  jiraTableBody.querySelectorAll('.save-jira-btn').forEach(button => {
    button.addEventListener('click', () => {
      const testId = parseInt(button.getAttribute('data-id'));
      const row = button.closest('tr');
      const leadSelect = row.querySelector(`select[data-field="lead"]`);
      const leadValue = leadSelect.value;
      saveJiraTest(testId, 'lead', leadValue);
    });
  });

  jiraTableBody.querySelectorAll('textarea, select:not([data-field="lead"]), input').forEach(element => {
    element.addEventListener('change', (e) => {
      const testId = parseInt(e.target.getAttribute('data-id'));
      const field = e.target.getAttribute('data-field');
      const value = e.target.value;
      saveJiraTest(testId, field, value);
    });
  });
}














document.getElementById("jiraFirstPage").onclick = () => { jiraCurrentPage = 1; renderJiraTable(); };
document.getElementById("jiraPrevPage").onclick = () => { if (jiraCurrentPage > 1) jiraCurrentPage--; renderJiraTable(); };
document.getElementById("jiraNextPage").onclick = () => {
  const totalPages = Math.ceil(filteredJiraTests.length / jiraPageSize);
  if (jiraCurrentPage < totalPages) jiraCurrentPage++; renderJiraTable();
};
document.getElementById("jiraLastPage").onclick = () => {
  jiraCurrentPage = Math.ceil(filteredJiraTests.length / jiraPageSize); renderJiraTable();
};

document.getElementById('jiraTitleSearch').addEventListener('input', applyJiraFilters);
document.getElementById('jiraTypeFilter').addEventListener('change', applyJiraFilters);
document.getElementById('analysisStatusFilter').addEventListener('change', applyJiraFilters);
document.getElementById('jiraStatusFilter').addEventListener('change', applyJiraFilters);
document.getElementById('assignedToFilterJira').addEventListener('change', applyJiraFilters);

async function enrichJiraWithLeadNames(tests) {
    await fetchAllUsers(); // Ensure usersCache is populated
    tests.forEach(t => {
      // Ensure lead is treated as a string for consistency with select2
      t.lead = t.lead ? String(t.lead) : '';
      t.lead_name = t.lead && usersCache[t.lead] ? usersCache[t.lead].name : 'Unassigned';
    });
  }

// ... (rest of the code remains unchanged)





    async function openEditModal(engagementId) {
      editModalChanged = false;
      currentEditingEngagement = allEngagements.find(e => e.id === engagementId);
      if (!currentEditingEngagement) return;
      
      await fetchAllUsers();
      await fetchAllProducts();
      
      const assignedToSelect = document.getElementById('editAssignedTo');
      assignedToSelect.innerHTML = '<option value="">Unassigned</option>';
      Object.values(usersCache).forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = user.name;
        assignedToSelect.appendChild(option);
      });
      
      const productSelect = document.getElementById('editProduct');
      productSelect.innerHTML = '<option value="">Select Product</option>';
      Object.values(productsCache).forEach(product => {
        const option = document.createElement('option');
        option.value = product.id;
        option.textContent = product.name;
        productSelect.appendChild(option);
      });
      
      document.getElementById('editId').value = currentEditingEngagement.id;
      document.getElementById('editCreated').value = currentEditingEngagement.created.slice(0, 10);
      document.getElementById('editCreatedBy').value = currentEditingEngagement.reason || '';
      document.getElementById('editName').value = currentEditingEngagement.name;
      document.getElementById('editAssignedTo').value = currentEditingEngagement.lead || '';
      document.getElementById('editProduct').value = currentEditingEngagement.product || '';
      document.getElementById('editAppSecETA').value = currentEditingEngagement.target_start ? currentEditingEngagement.target_start.slice(0, 10) : '';
      document.getElementById('editRmETA').value = currentEditingEngagement.target_end ? currentEditingEngagement.target_end.slice(0, 10) : '';
      document.getElementById('editStatusAnalyst').value = currentEditingEngagement.status || 'Not Started';
      document.getElementById('editStatusMentor').value = currentEditingEngagement.branch_tag || 'Not Started';
      document.getElementById('editStatusLead').value = currentEditingEngagement.commit_hash || 'Not Started';
      document.getElementById('editIR').value = currentEditingEngagement.version || '';
      document.getElementById('editComment').value = currentEditingEngagement.description || '';
      
      $('#editAssignedTo, #editProduct').select2({
        theme: 'bootstrap-5',
        width: '100%',
        dropdownParent: $('#editEngagementModal')
      });
      
      editEngagementModal.show();
    }

    function handleCloseEditModal() {
      if (editModalChanged) {
        confirmCloseModal.show();
      } else {
        editEngagementModal.hide();
      }
    }

    function handleXClose(e) {
      e.preventDefault();
      if (editModalChanged) {
        confirmCloseModal.show();
      } else {
        editEngagementModal.hide();
      }
    }

    function confirmCloseEditModal() {
      confirmCloseModal.hide();
      editEngagementModal.hide();
    }

    async function saveEngagementChanges() {
      if (!currentEditingEngagement) return;
      
      loadingModal.show();
      
      const formData = {
        id: currentEditingEngagement.id,
        name: document.getElementById('editName').value,
        target_start: document.getElementById('editAppSecETA').value || null,
        target_end: document.getElementById('editRmETA').value || null,
        lead: document.getElementById('editAssignedTo').value || null,
        product: document.getElementById('editProduct').value,
        status: document.getElementById('editStatusAnalyst').value,
        branch_tag: document.getElementById('editStatusMentor').value,
        commit_hash: document.getElementById('editStatusLead').value,
        version: document.getElementById('editIR').value,
        description: document.getElementById('editComment').value
      };
      
      if (!formData.name || !formData.target_start || !formData.target_end || !formData.product) {
        showToast('Please fill all required fields: Name, AppSec ETA, RM ETA, and Product', 'error');
        loadingModal.hide();
        return;
      }
      
      try {
        const response = await fetch(`https://demo.defectdojo.org/api/v2/engagements/${currentEditingEngagement.id}/`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.getElementById('csrfToken').value
          },
          body: JSON.stringify(formData)
        });
        
        if (response.ok) {
          const updatedEngagement = await response.json();
          const index = allEngagements.findIndex(e => e.id === updatedEngagement.id);
          if (index !== -1) {
            allEngagements[index] = updatedEngagement;
            if (updatedEngagement.lead) {
              allEngagements[index].lead_name = usersCache[updatedEngagement.lead]?.name || 'Unassigned';
            } else {
              allEngagements[index].lead_name = 'Unassigned';
            }
            const filteredIndex = filteredEngagements.findIndex(e => e.id === updatedEngagement.id);
            if (filteredIndex !== -1) {
              filteredEngagements[filteredIndex] = updatedEngagement;
            }
            updateStatusCounts();
            renderTable();
          }
          
          editEngagementModal.hide();
          showToast('Patch updated successfully', 'success');
        } else {
          const errorData = await response.json();
          console.error('Failed to update Patch:', errorData);
          showToast('Failed to update Patch: ' + (errorData.message || 'Unknown error'), 'error');
        }
      } catch (error) {
        console.error('Error updating Patch:', error);
        showToast('Error updating Patch', 'error');
      } finally {
        loadingModal.hide();
      }
    }

    function openSummaryModal() {
      const summaryData = {};
      allEngagements.forEach(e => {
        const leadName = e.lead_name;
        if (!summaryData[leadName]) {
          summaryData[leadName] = { 'Not Started': 0, 'In Progress': 0, 'On Hold': 0, 'Completed': 0, Total: 0 };
        }
        summaryData[leadName][e.status]++;
        summaryData[leadName].Total++;
      });

      const totals = { 'Not Started': 0, 'In Progress': 0, 'On Hold': 0, 'Completed': 0, Total: 0 };
      Object.values(summaryData).forEach(counts => {
        totals['Not Started'] += counts['Not Started'];
        totals['In Progress'] += counts['In Progress'];
        totals['On Hold'] += counts['On Hold'];
        totals['Completed'] += counts['Completed'];
        totals.Total += counts.Total;
      });

      const summaryTableBody = document.getElementById('summaryTableBody');
      summaryTableBody.innerHTML = Object.entries(summaryData).map(([lead, counts]) => `
        <tr>
          <td>${lead}</td>
          <td>${counts['Not Started']}</td>
          <td>${counts['In Progress']}</td>
          <td>${counts['On Hold']}</td>
          <td>${counts['Completed']}</td>
          <td class="total-column">${counts.Total}</td>
        </tr>
      `).join('') + `
        <tr class="total-row">
          <td>Total</td>
          <td>${totals['Not Started']}</td>
          <td>${totals['In Progress']}</td>
          <td>${totals['On Hold']}</td>
          <td>${totals['Completed']}</td>
          <td class="total-column">${totals.Total}</td>
        </tr>
      `;

      summaryModal.show();
    }

    function openCompletedSummaryModal() {
      document.getElementById('completedStartDate').value = '';
      document.getElementById('completedEndDate').value = '';
      document.getElementById('totalCompleted').textContent = '0';
      document.getElementById('approvedCount').textContent = '0';
      document.getElementById('approvedWithExceptionCount').textContent = '0';
      document.getElementById('rejectedCount').textContent = '0';
      completedSummaryModal.show();
    }

    async function openClosedModal() {
      await fetchClosedEngagements();
      viewClosedModal.show();
    }

    async function openNewEngagementModal() {
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(today.getDate() + 1);

      document.getElementById('newName').value = '';
      document.getElementById('newTargetStart').value = today.toISOString().slice(0, 10);
      document.getElementById('newTargetEnd').value = tomorrow.toISOString().slice(0, 10);
      document.getElementById('newStatus').value = 'Not Started';
      document.getElementById('newCreatedBy').value = '';

      // Populate Assigned To dropdown
      await fetchAllUsers();
      const leadSelect = document.getElementById('newLead');
      leadSelect.innerHTML = '<option value="">Unassigned</option>';
      Object.values(usersCache).forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = user.name;
        leadSelect.appendChild(option);
      });

      // Populate Product dropdown
      await fetchAllProducts();
      const productSelect = document.getElementById('newProduct');
      productSelect.innerHTML = '<option value="">Select Product</option>';
      Object.values(productsCache).forEach(product => {
        const option = document.createElement('option');
        option.value = product.id;
        option.textContent = product.name;
        productSelect.appendChild(option);
      });

      // Initialize Select2 for searchable dropdowns
      $('#newLead, #newProduct').select2({
        theme: 'bootstrap-5',
        width: '100%',
        dropdownParent: $('#newEngagementModal'),
        placeholder: 'Search...',
        allowClear: true
      });

      newEngagementModal.show();
    }

    function handleCloseNewModal() {
      newEngagementModal.hide();
    }

    function handleNewXClose(e) {
      e.preventDefault();
      newEngagementModal.hide();
    }

    async function saveNewEngagement() {
      loadingModal.show();
      
      const formData = {
        name: document.getElementById('newName').value,
        target_start: document.getElementById('newTargetStart').value,
        target_end: document.getElementById('newTargetEnd').value,
        status: document.getElementById('newStatus').value,
        lead: document.getElementById('newLead').value || null,
        product: document.getElementById('newProduct').value,
        reason: document.getElementById('newCreatedBy').value,
        tags: ["pci"]
      };
      
      if (!formData.name || !formData.target_start || !formData.target_end || !formData.product || !formData.reason) {
        showToast('Please fill all required fields: Name, AppSec ETA, RM ETA, Product, and Created By', 'error');
        loadingModal.hide();
        return;
      }
      
      try {
        const response = await fetch('https://demo.defectdojo.org/api/v2/engagements/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.getElementById('newCsrfToken').value
          },
          body: JSON.stringify(formData)
        });
        
        if (response.ok) {
          const newEngagement = await response.json();
          newEngagement.lead_name = formData.lead ? usersCache[formData.lead]?.name || 'Unassigned' : 'Unassigned';
          allEngagements.push(newEngagement);
          filteredEngagements.push(newEngagement);
          updateStatusCounts();
          renderTable();
          
          newEngagementModal.hide();
          showToast('New Patch created successfully', 'success');
        } else {
          const errorData = await response.json();
          console.error('Failed to create Patch:', errorData);
          showToast('Failed to create Patch: ' + (errorData.message || 'Unknown error'), 'error');
        }
      } catch (error) {
        console.error('Error creating Patch:', error);
        showToast('Error creating Patch', 'error');
      } finally {
        loadingModal.hide();
      }
    }

    function confirmCloseEngagement(engagementId) {
      engagementToClose = engagementId;
      confirmCloseEngagementModal.show();
    }

    async function closeEngagement() {
      if (!engagementToClose) return;

      loadingModal.show();
      
      try {
        const response = await fetch(`https://demo.defectdojo.org/api/v2/engagements/${engagementToClose}/close/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.getElementById('csrfToken').value
          }
        });
        
        if (response.ok) {
          const index = allEngagements.findIndex(e => e.id === engagementToClose);
          if (index !== -1) {
            const closedEngagement = allEngagements.splice(index, 1)[0];
            closedEngagements.push(closedEngagement);
          }
          const filteredIndex = filteredEngagements.findIndex(e => e.id === engagementToClose);
          if (filteredIndex !== -1) {
            filteredEngagements.splice(filteredIndex, 1);
          }
          updateStatusCounts();
          renderTable();
          renderClosedTable();
          
          confirmCloseEngagementModal.hide();
          showToast('Engagement closed successfully', 'success');
        } else {
          const errorData = await response.json();
          console.error('Failed to close engagement:', errorData);
          showToast('Failed to close engagement: ' + (errorData.message || 'Unknown error'), 'error');
        }
      } catch (error) {
        console.error('Error closing engagement:', error);
        showToast('Error closing engagement', 'error');
      } finally {
        loadingModal.hide();
        engagementToClose = null;
      }
    }

    async function reopenEngagement(engagementId) {
      loadingModal.show();
      
      try {
        const response = await fetch(`https://demo.defectdojo.org/api/v2/engagements/${engagementId}/reopen/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.getElementById('csrfToken').value
          }
        });
        
        if (response.ok) {
          const index = closedEngagements.findIndex(e => e.id === engagementId);
          if (index !== -1) {
            const reopenedEngagement = closedEngagements.splice(index, 1)[0];
            reopenedEngagement.status = 'Not Started'; // Assuming reopen sets it to Not Started
            allEngagements.push(reopenedEngagement);
            filteredEngagements.push(reopenedEngagement);
          }
          updateStatusCounts();
          renderTable();
          renderClosedTable();
          
          showToast('Patch reopened successfully', 'success');
        } else {
          const errorData = await response.json();
          console.error('Failed to reopen Patch:', errorData);
          showToast('Failed to reopen Patch: ' + (errorData.message || 'Unknown error'), 'error');
        }
      } catch (error) {
        console.error('Error reopening Patch:', error);
        showToast('Error reopening Patch', 'error');
      } finally {
        loadingModal.hide();
      }
    }

    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer') || createToastContainer();
      
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      
      const toastContent = `
        <div class="d-flex">
          <div class="toast-body">
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      
      toast.innerHTML = toastContent;
      toastContainer.appendChild(toast);
      
      const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: 3000 });
      bsToast.show();
      
      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }









async function openTestsSummaryModal() {
  loadingModal.show();
  try {
    // Ensure usersCache is populated for lead names
    await fetchAllUsers();

    // Filter active engagements
    const activeEngagements = allEngagements.filter(e => e.active === true);

    // Aggregate data by lead and branch_tag
    const summaryData = {};
    activeEngagements.forEach(e => {
      const leadId = e.lead || 'unassigned';
      const leadName = leadId === 'unassigned' ? 'Unassigned' : usersCache[leadId]?.name || 'Unknown';
      const branchTag = e.branch_tag || 'Not Started'; // Default to 'Not Started' if undefined

      if (!summaryData[leadName]) {
        summaryData[leadName] = {
          'Not Started': 0,
          'In Progress': 0,
          'On Hold': 0,
          'Completed': 0,
          Total: 0
        };
      }
      summaryData[leadName][branchTag]++;
      summaryData[leadName].Total++;
    });

    // Calculate totals
    const totals = {
      'Not Started': 0,
      'In Progress': 0,
      'On Hold': 0,
      'Completed': 0,
      Total: 0
    };
    Object.values(summaryData).forEach(counts => {
      totals['Not Started'] += counts['Not Started'];
      totals['In Progress'] += counts['In Progress'];
      totals['On Hold'] += counts['On Hold'];
      totals['Completed'] += counts['Completed'];
      totals.Total += counts.Total;
    });

    // Render table
    const summaryTableBody = document.getElementById('testsSummaryTableBody');
    summaryTableBody.innerHTML = Object.entries(summaryData).map(([lead, counts]) => `
      <tr>
        <td>${lead}</td>
        <td>${counts['Not Started']}</td>
        <td>${counts['In Progress']}</td>
        <td>${counts['On Hold']}</td>
        <td>${counts['Completed']}</td>
        <td class="total-column">${counts.Total}</td>
      </tr>
    `).join('') + `
      <tr class="total-row">
        <td>Total</td>
        <td>${totals['Not Started']}</td>
        <td>${totals['In Progress']}</td>
        <td>${totals['On Hold']}</td>
        <td>${totals['Completed']}</td>
        <td class="total-column">${totals.Total}</td>
      </tr>
    `;

    testsSummaryModal.show();
  } catch (error) {
    console.error('Error opening Tests Summary modal:', error);
    showToast('Error loading Tests Summary', 'error');
  } finally {
    loadingModal.hide();
  }
}











    function createToastContainer() {
      const container = document.createElement('div');
      container.id = 'toastContainer';
      container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
      container.style.zIndex = '5';
      document.body.appendChild(container);
      return container;
    }

    window.onload = fetchEngagements;
  </script>
</body>
</html>